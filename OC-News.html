<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="auto">
<head>
  <!--
    ONX-News — Apple-clean, pure white/black.

    This pass (perf + polish):
    • Removed Google Trends section + all related logic
    • Apple-style centered Editions segmented control (desktop & mobile) with perfect spacing
    • Image pipeline overhaul for speed:
        - Responsive proxy (wsrv.nl) → modern WebP, smart widths (srcset/sizes)
        - Lazy loading via IntersectionObserver (zero-jank, content-visibility)
        - Priority for first hero image only (LCP)
    • Content-visibility for offscreen cards (CLS-safe)
    • Kept all existing features: feeds, hero, trending, saves, weather (with cinematic FX), theme, preloader
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONX-News — The AI Workspace. Without Limits.</title>
  <meta name="description" content="ONX-News surfaces the most breaking headlines with an Apple-style minimal hero. Private, fast, and elegant." />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" href="logo.svg" type="image/svg+xml" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Preconnects (feeds + image proxy) -->
  <link rel="preconnect" href="https://r.jina.ai" crossorigin>
  <link rel="preconnect" href="https://api.allorigins.win" crossorigin>
  <link rel="preconnect" href="https://wsrv.nl" crossorigin>
  <link rel="dns-prefetch" href="//wsrv.nl">
  <link rel="dns-prefetch" href="//r.jina.ai">
  <link rel="dns-prefetch" href="//api.allorigins.win">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','SF Pro Text','Segoe UI','Roboto','Apple Color Emoji','Helvetica Neue','Arial','Noto Color Emoji','sans-serif'] },
          boxShadow: { 'oc-soft': '0 8px 24px -10px rgba(0,0,0,0.35)' },
          keyframes: {
            'pulse-soft': { '0%,100%': { opacity: .65 }, '50%': { opacity: 1 } },
            'ticker': { '0%': { transform: 'translateX(0)' }, '100%': { transform: 'translateX(-50%)' } },
            'progress': { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
            'shine': { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
            'fade-in': { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
            'fade-out': { '0%': { opacity: 1 }, '100%': { opacity: 0 } },
            'aurora-pan': {
              '0%': { transform: 'translate3d(-6%, -8%, 0) rotate(0.001deg)' },
              '50%': { transform: 'translate3d(4%, 6%, 0) rotate(0.001deg)' },
              '100%': { transform: 'translate3d(-4%, 4%, 0) rotate(0.001deg)' }
            },
            'reveal-up': {
              '0%': { opacity: 0, transform: 'translateY(10px) scale(0.995)' },
              '100%': { opacity: 1, transform: 'translateY(0) scale(1)' }
            },
            'glow-pulse': {
              '0%,100%': { opacity: .55, filter: 'blur(34px) saturate(1.2)' },
              '50%': { opacity: .9, filter: 'blur(40px) saturate(1.35)' }
            }
          },
          animation: {
            'pulse-soft': 'pulse-soft 3.6s ease-in-out infinite',
            'ticker': 'ticker 18s linear infinite',
            'progress': 'progress 1.1s ease-in-out infinite',
            'shine': 'shine 1.8s ease-in-out infinite',
            'fade-in': 'fade-in .45s ease forwards',
            'fade-out': 'fade-out .45s ease forwards',
            'aurora-pan': 'aurora-pan 36s ease-in-out infinite alternate',
            'reveal-up': 'reveal-up .6s cubic-bezier(.2,.7,.22,1) both',
            'glow-pulse': 'glow-pulse 8s ease-in-out infinite'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --logo-size:34px;--logo-size-lg:40px;
      --radius:14px;
      --bg:#0b0b0c;--surface:#000000;--elev:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.12);
      --text:#f5f7fb;--sub:#a6acb8;--accent:#356dff;--live:#ff3b30;
      --chip:rgba(255,255,255,0.06);--chip-border:rgba(255,255,255,0.12);
      --card-hover:rgba(255,255,255,0.06);
      --header-h:60px;

      /* Preloader (force Apple-white sheet + black mark) */
      --preload-bg:#ffffff; --preload-text:#000000;
    }
    html.light{
      /* Page background slightly grey (Apple vibe), cards stay pure white */
      --bg:#f5f6f8;              /* <— main backdrop */
      --surface:#ffffff;         /* <— cards */
      --elev:rgba(10,10,15,0.035);
      --border:rgba(5,13,38,0.10);
      --text:#0b0b0e;--sub:#5a6274;--accent:#356dff;--live:#e5484d;
      --chip:rgba(0,0,0,0.035);--chip-border:rgba(0,0,0,0.08);
      --card-hover:rgba(0,0,0,0.045);
    }
    .text-balance{ text-wrap:balance }
    .no-scrollbar::-webkit-scrollbar{ display:none }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }

    body{ overscroll-behavior: contain; }
    header{ backface-visibility:hidden; transform:translateZ(0); will-change:transform; }

    @media (prefers-reduced-motion: reduce){
      .animate-pulse-soft,.animate-ticker,.animate-progress,.animate-shine,
      .animate-aurora-pan,.animate-reveal-up,.animate-glow-pulse{ animation:none!important }
      .hero-track{ scroll-behavior:auto!important }
      #wxNowCard{ transform:none !important }
    }

    /* Base surfaces — pure white cards in light mode */
    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius) }
    .chip{ background:var(--chip); border:1px solid var(--chip-border) }

    /* Buttons — no outlines/borders; soft hover fill; custom focus ring only */
    .btn{ background:transparent; border:0; }
    .btn:hover{ background:var(--card-hover) }
    .btn:focus{ outline:0 }
    .btn:focus-visible{ box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 38%, transparent); border-radius:10px }

    .hairline{ height:1px; background:var(--border) }
    .link-btn{ border:0; background:transparent; padding:6px 8px; font-size:.875rem; color:var(--sub); display:inline-flex; align-items:center; gap:8px; border-radius:8px }
    .link-btn:hover{ color:var(--text) }
    .link-btn:focus-visible{ outline:2px solid color-mix(in oklab, var(--accent) 40%, transparent); outline-offset:2px; border-radius:10px }

    .logo-img{ height:var(--logo-size); width:auto; transition:filter .2s ease }
    @media (min-width:640px){ .logo-img{ height:var(--logo-size-lg) } }
    .dark .logo-img{ filter:invert(1) brightness(1.08) }

    /* Preloader — Apple sheet */
    #preload{ position:fixed; inset:0; z-index:70; display:grid; place-items:center; background:var(--preload-bg) }
    body.preloading{ overflow:hidden }
    .preload-wrap{ display:grid; gap:14px; place-items:center; text-align:center; padding:24px; color:var(--preload-text) }
    .preload-spinner{ width:28px; height:28px; border-radius:999px; border:2px solid rgba(0,0,0,.15); border-top-color:#000; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .preload-line{ font-weight:800; letter-spacing:-0.015em; font-size:clamp(18px,4.8vw,22px) }

    /* Segmented control — centered & spaced like Apple */
    .seg{ display:inline-flex; align-items:center; border:1px solid var(--border); border-radius:999px; padding:3px; background:var(--surface); white-space:nowrap; gap:2px }
    .seg button{ padding:7px 12px; border-radius:999px; font-size:12px; line-height:1; border:0; font-weight:600; letter-spacing:.01em }
    .seg button.active{ background:var(--card-hover) }
    @media (min-width:640px){ .seg button{ padding:8px 14px; font-size:12px } }

    /* Section lead */
    .section-lead{ font-weight:800; letter-spacing:-0.02em; font-size:clamp(28px,8vw,48px); color:var(--live); }
    .date-badge{ font-weight:600; letter-spacing:.02em; }

    /* Hero */
    .hero-section-container{ padding-block:1.1rem }
    @media (min-width:640px){ .hero-section-container{ padding-block:1.6rem } }
    @media (min-width:1024px){ .hero-section-container{ padding-block:2rem } }
    #heroCard{ min-height:58svh; display:flex; flex-direction:column; overflow:hidden; border-radius:var(--radius) }
    .hero-media{ position:relative; border-radius:calc(var(--radius) - 2px); overflow:hidden; border:1px solid var(--border); flex:1; min-height:0 }
    .hero-track{ display:flex; height:100%; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; scroll-behavior:smooth; transform:translateZ(0); will-change:transform; }
    .hero-slide{ position:relative; flex:0 0 100%; width:100%; height:100%; scroll-snap-align:center }
    .hero-slide a{ position:absolute; inset:0; display:block }
    .hero-slide img{ width:100%; height:100%; object-fit:cover; display:block }

    /* Remove old global fog */
    .hero-gradient{ display:none !important }

    /* Glass behind text */
    .hero-overlay-text{
      position:absolute; inset-inline:16px; bottom:58px; display:grid; gap:8px; pointer-events:none; z-index:2;
    }
    .hero-glass{
      display:inline-block;
      max-width:min(92%, 860px);
      padding:10px 12px;
      border-radius:14px;
      color:#fff;
      background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.55));
      backdrop-filter: blur(10px) saturate(1.15);
      -webkit-backdrop-filter: blur(10px) saturate(1.15);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 8px 24px rgba(0,0,0,.28), inset 0 1px rgba(255,255,255,.10);
      text-shadow: 0 2px 14px rgba(0,0,0,.45);
    }
    .hero-overlay-text .k{ font-size:10px; letter-spacing:.08em; text-transform:uppercase; opacity:.9; color:#fff }
    .hero-overlay-text h2{ font-size:clamp(18px, 3.4vw, 28px); line-height:1.12; font-weight:800; color:#fff; letter-spacing:-.015em }

    .hero-nav{ position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; pointer-events:none; padding:8px; z-index:3 }
    .hero-nav button{ pointer-events:auto; border:0; background:rgba(0,0,0,.28); backdrop-filter:blur(6px); color:#fff; width:40px; height:40px; border-radius:999px; display:grid; place-items:center }
    html.light .hero-nav button{ background:rgba(255,255,255,.65); color:#000 }

    /* Apple-minimal dots */
    .hero-dots{
      position:absolute; bottom:14px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; z-index:3; pointer-events:none;
    }
    .hero-dots span{
      height:4px; width:10px; border-radius:999px;
      background:rgba(255,255,255,.42);
      opacity:.9; transition:width .25s ease, opacity .25s ease, background .25s ease;
      backdrop-filter: blur(4px);
    }
    .hero-dots span.active{ width:18px; background:#fff; opacity:1 }
    html.light .hero-dots span{ background:rgba(0,0,0,.26) }
    html.light .hero-dots span.active{ background:#000; }

    /* Mobile hero */
    @media (max-width: 639.98px){
      .hero-section-container{ padding-inline:1rem !important; padding-block:1rem !important; }
      #heroCard{ padding:0!important; border:1px solid var(--border)!important; border-radius:var(--radius)!important; box-shadow:var(--oc-soft)!important; }
      .hero-media{ border:1px solid var(--border)!important; border-radius:calc(var(--radius) - 2px)!important; height:54svh; min-height:54svh }
      .hero-nav{ display:none!important }
      .hero-overlay-text{ bottom:62px; }
      .hero-dots{ bottom:14px }
    }

    /* Header behavior */
    body.hero-immersive header{ position:fixed!important; top:0; left:0; right:0; transform:translateY(-100%); opacity:0; pointer-events:none }
    header{ position:sticky; top:0; z-index:40; background:var(--surface); transition:transform .28s ease, opacity .28s ease }

    /* Generic media helper */
    .tile-img{ width:100%; object-fit:cover; border:1px solid var(--border); border-radius:12px }

    /* Weather — layout */
    .wx-grid { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px }
    @media (min-width:640px){ .wx-grid{ grid-template-columns: repeat(4,minmax(0,1fr)); } }
    .wx-pill { border-radius:12px; padding:10px 12px; border:1px solid var(--border); background:var(--surface) }
    .wx-rail { display:flex; gap:8px; overflow:auto; scroll-snap-type:x mandatory; padding-block:4px }
    .wx-rail > div { scroll-snap-align:center; }

    /* Weather — cinematic background & shine */
    #wxNowCard{
      transform-style: preserve-3d;
      transition: transform .35s ease, box-shadow .35s ease;
      isolation: isolate;
    }
    #wxNowCard::before{
      content:"";
      position:absolute; inset:-18%;
      background:
        radial-gradient(1200px 500px at 20% 0%, rgba(120,170,255,.22), transparent 60%),
        radial-gradient(800px 500px at 80% 10%, rgba(255,120,200,.20), transparent 60%),
        conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.08), rgba(0,0,0,0), rgba(255,255,255,.06), rgba(0,0,0,0));
      filter: blur(30px) saturate(1.15);
      z-index:0; opacity:.38;
      animation: aurora-pan 36s ease-in-out infinite alternate;
      pointer-events:none;
    }
    #wxNowCard::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.06) 50%, transparent 100%);
      background-size: 220% 100%;
      mix-blend-mode: soft-light;
      animation: shine 3.2s ease-in-out infinite;
      z-index:1; pointer-events:none; opacity:.35;
    }

    /* Weather FX canvas */
    #wxFx{
      position:absolute; inset:0; pointer-events:none; z-index:0;
      mix-blend-mode: screen; opacity:.7;
    }
    html.light #wxFx{ mix-blend-mode: normal; opacity:.6; }

    /* ========= NO-OUTLINE SWEEP ========= */
    *:focus{ outline: none !important; }
    .card,
    .chip,
    .hero-media,
    .tile-img,
    .wx-pill,
    .date-badge,
    .brand-fb { border: 0 !important; }
    .border { border-width: 0 !important; }
    .border-\[var\(--border\)\] { border-color: transparent !important; border-width: 0 !important; }
    .seg{ border: 0 !important; }
    .hero-dots span{ border: 0 !important; }
    #tickerWrap{ display: none !important; }
    #heroCard{ border: 0 !important; }
    #heroCard .hero-media{ border: 0 !important; }

    /* ===== Apple-style "No Image Found" placeholder ===== */
    .noimg{
      width:100%; height:100%;
      display:grid; place-items:center; text-align:center;
      border-radius:12px;
      background: linear-gradient(180deg,#f0f2f5,#e9ecf1);
      color:#717985;
      font-weight:600; letter-spacing:.02em;
      user-select:none;
    }
    .noimg > span{ font-size:12px; }
    .dark .noimg{
      background:#14161a;
      color:#a8b0bb;
    }

    /* Performance: offscreen layout isolation */
    .cv-auto{ content-visibility:auto; contain-intrinsic-size: 700px 400px; }
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)] antialiased selection:bg-[var(--accent)]/20 selection:text-[var(--text)] preloading hero-immersive">
<!-- Fullscreen Apple-style Preloader -->
<div id="preload" aria-live="polite" aria-busy="true">
  <div class="preload-wrap">
    <div class="preload-spinner"></div>
    <div id="preloadLine" class="preload-line" style="font-weight:700; font-size:1.25rem; text-align:center; letter-spacing:-0.01em; margin-top:32px;">
      ONX-News
    </div>
  </div>
</div>

<style>
  .preload-spinner { width: 36px; height: 36px; border: 3px solid rgba(0, 0, 0, 0.15); border-top-color: #000; border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>

  <!-- Tiny top loader -->
  <div id="topLoader" class="fixed inset-x-0 top-0 h-[2px] overflow-hidden z-[60] hidden">
    <div class="h-full w-1/3 bg-[var(--accent)] animate-progress"></div>
  </div>

  <!-- Header (brand • centered editions • actions) -->
  <header class="border-b border-[var(--border)]">
    <div class="mx-auto max-w-7xl px-3 sm:px-6 lg:px-8 py-2">
      <div class="grid grid-cols-[auto_1fr_auto] items-center gap-2 sm:gap-3">
        <!-- Brand -->
        <div class="flex items-center gap-2 min-w-0">
          <a href="index.html" class="shrink-0" aria-label="OpenCounsel Home">
            <img src="logo.svg" alt="OpenCounsel" class="logo-img" />
          </a>
          <div class="hidden sm:block text-sm text-[var(--sub)] truncate">The AI Workspace. Without Limits.</div>
        </div>

        <!-- Editions — perfectly centered, evenly spaced, Apple-tight -->
        <nav class="flex justify-center">
          <div class="seg overflow-x-auto no-scrollbar max-w-full">
            <button class="seg-btn" data-ed="ALL">All</button>
            <button class="seg-btn" data-ed="GLOBAL">Global</button>
            <button class="seg-btn" data-ed="US">US</button>
            <button class="seg-btn" data-ed="CA">Canada</button>
            <button class="seg-btn" data-ed="FIN">Financial</button>
          </div>
        </nav>

        <!-- Actions: Weather • Theme -->
        <div class="flex items-center justify-end gap-1.5 sm:gap-2">
          <button id="weatherBtn" class="hidden sm:inline-flex link-btn" title="Weather (W)">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15a4 4 0 0 0 4 4h11a3 3 0 0 0 0-6h-1"/><path d="M16 7a4 4 0 0 0-7.9 1"/></svg>
            <span class="hidden md:inline">Weather</span>
          </button>
          <button id="weatherBtnMobile" class="sm:hidden link-btn shrink-0" title="Weather (W)">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15a4 4 0 0 0 4 4h11a3 3 0 0 0 0-6h-1"/><path d="M16 7a4 4 0 0 0-7.9 1"/></svg>
          </button>

          <button id="themeBtn" class="link-btn shrink-0" title="Toggle theme (T)">
            <span id="themeIcon" class="inline-flex items-center">
              <svg id="sun" class="size-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4" /><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
              <svg id="moon" class="size-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
            </span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== NEWS (default page) ===== -->
  <main id="newsMain">
    <!-- HERO + SECTION LEAD -->
    <section class="relative">
      <div class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 hero-section-container">
        <!-- Date row -->
        <div class="flex items-center justify-between mb-2 sm:mb-3">
          <div class="text-[11px] uppercase tracking-widest text-[var(--sub)] font-semibold">ONX-News</div>
          <div id="todayBadge" class="chip date-badge rounded-full px-2.5 py-1 text-[11px]">—</div>
        </div>

        <h1 class="section-lead mt-6 mb-3 sm:mb-4">Breaking News</h1>

        <div id="heroCard" class="card shadow-oc-soft p-0 relative overflow-hidden">
          <figure id="heroMedia" class="hero-media bg-[var(--surface)]">
            <div id="heroTrack" class="hero-track no-scrollbar"><!-- Slides injected --></div>
            <div class="hero-nav">
              <button id="prevTopBtn" aria-label="Previous top"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg></button>
              <button id="nextTopBtn" aria-label="Next top"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M9 6l6 6-6 6"/></svg></button>
            </div>
            <div id="heroDots" class="hero-dots"></div>
            <div class="hero-gradient"></div>
          </figure>

          <!-- Ticker (hidden) -->
          <div class="px-4 sm:px-0">
            <div class="mt-3 sm:mt-4 flex items-center gap-3">
              <span id="updatedAt" class="ml-auto text-xs text-[var(--sub)]">—</span>
            </div>
            <div id="tickerWrap" class="mt-4 sm:mt-6 overflow-hidden">
              <div id="ticker" class="flex gap-2 min-w-[200%] whitespace-nowrap"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SUB TILES -->
    <section class="relative">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-4 pb-2">
        <!-- Two tall vertical cards, then full-width rows -->
        <ul id="newsList" class="grid grid-cols-2 gap-3 sm:gap-4 auto-rows-auto"><!-- Populated by JS --></ul>
      </div>
      <div class="hairline"></div>
    </section>

    <!-- TRENDING -->
    <section id="trendingSection" class="relative">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-4 pb-6 sm:py-8">
        <div class="flex items-center justify-between gap-3 mb-3">
          <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Trending — Most Read</h2>
          <div class="text-xs text-[var(--sub)]" id="trendHint">Based on # of sources + recency</div>
        </div>
        <div id="trendingRail" class="rail no-scrollbar"><!-- trending cards injected --></div>
      </div>
      <div class="hairline"></div>
    </section>
  </main>

  <!-- ===== WEATHER (second page) ===== -->
  <main id="weatherMain" class="hidden">
    <section class="relative">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
        <div class="flex items-center justify-between gap-3 mb-2">
          <h1 class="section-lead">Weather</h1>
          <div class="seg">
            <button id="newsTab" class="seg-btn">News</button>
          </div>
        </div>

        <!-- Location controls -->
        <div class="card p-3 sm:p-4 mb-4">
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <div class="relative flex-1">
              <input id="wxQuery" class="w-full btn rounded-lg px-3 py-2 text-sm outline-none focus:ring-0 bg-transparent" placeholder="City, address, or postal code…" />
              <kbd class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-[var(--sub)]">Enter</kbd>
            </div>
            <button id="wxMyLocation" class="btn rounded-lg px-3 py-2 text-sm">Use my location</button>
            <div class="text-xs text-[var(--sub)]" id="wxMeta">—</div>
          </div>
        </div>

        <!-- Current conditions (FX canvas + aurora + shine live here) -->
        <div id="wxNowCard" class="card p-4 sm:p-6 mb-4 relative overflow-hidden">
          <div class="flex items-end justify-between gap-4 relative z-10">
            <div>
              <div id="wxPlace" class="text-2xl sm:text-3xl font-extrabold tracking-tight">—</div>
              <div id="wxDesc" class="text-sm text-[var(--sub)]">—</div>
            </div>
            <div class="text-right">
              <div id="wxTemp" class="text-4xl sm:text-6xl font-extrabold leading-none">—°</div>
              <div id="wxFeels" class="text-xs text-[var(--sub)]">Feels like —°</div>
            </div>
          </div>
          <div class="mt-4 wx-grid relative z-10">
            <div class="wx-pill"><div class="text-[11px] text-[var(--sub)]">Humidity</div><div id="wxHum" class="text-sm font-semibold">—%</div></div>
            <div class="wx-pill"><div class="text-[11px] text-[var(--sub)]">Wind</div><div id="wxWind" class="text-sm font-semibold">— km/h</div></div>
            <div class="wx-pill"><div class="text-[11px] text-[var(--sub)]">Precip</div><div id="wxPrec" class="text-sm font-semibold">— mm</div></div>
            <div class="wx-pill"><div class="text-[11px] text-[var(--sub)]">UV</div><div id="wxUV" class="text-sm font-semibold">—</div></div>
          </div>
        </div>

        <!-- Hourly -->
        <div class="card p-4 sm:p-5 mb-4">
          <div class="mb-2 text-sm font-semibold">Next 24 hours</div>
          <div id="wxHourly" class="wx-rail no-scrollbar"><!-- chips --></div>
        </div>

        <!-- Daily -->
        <div class="card p-4 sm:p-5">
          <div class="mb-2 text-sm font-semibold">7-day forecast</div>
          <div id="wxDaily" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"><!-- days --></div>
        </div>
      </div>
      <div class="hairline"></div>
    </section>
  </main>

  <script>
    /* ===== CONFIG ===== */
    const DEFAULT_EDITION = 'CA';
    const MAX_ITEMS = 64;
    const CYCLE_TOPS = true;
    const SHOW_IMAGES = true;
    const HERO_SLIDES = 10;
    const DOT_COUNT = 6;
    const PRELOAD_ON_REFRESH = true;

    const SORT_MODES = { NEWEST:'newest', OLDEST:'oldest', SOURCE:'source' };
    let sortMode = SORT_MODES.NEWEST;

    /* ===== FEEDS ===== */
    const FEEDS = {
      CA: [
        'https://news.google.com/rss?hl=en-CA&gl=CA&ceid=CA:en',
        'https://feeds.bbci.co.uk/news/rss.xml',
        'https://feeds.reuters.com/reuters/topNews',
        'https://feeds.reuters.com/reuters/worldNews',
        'https://rss.cnn.com/rss/cnn_topstories.rss',
        'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
        'https://www.theguardian.com/world/rss',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://apnews.com/hub/ap-top-news?utm_source=ap_rss&utm_medium=rss&utm_campaign=ap_top_news',
        'https://www.cbc.ca/cmlink/rss-topstories',
        'https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.822009',
        'https://globalnews.ca/feed/',
        'https://www.nationalpost.com/feed/',
        'https://feeds.reuters.com/reuters/businessNews',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        'https://www.ft.com/world?format=rss',
        'https://www.wsj.com/xml/rss/3_7085.xml',
        'https://www.theglobeandmail.com/arc/outboundfeeds/rss/?outputType=xml',
        'https://financialpost.com/feed/',
        'https://feeds.bloomberg.com/news.rss',
        'https://feeds.bloomberg.com/markets/news.rss'
      ],
      US: [
        'https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en',
        'https://feeds.bbci.co.uk/news/rss.xml',
        'https://feeds.reuters.com/reuters/topNews',
        'https://rss.cnn.com/rss/cnn_topstories.rss',
        'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
        'https://www.theguardian.com/us-news/rss',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://apnews.com/hub/ap-top-news?utm_source=ap_rss&utm_medium=rss&utm_campaign=ap_top_news',
        'https://www.npr.org/rss/rss.php?id=1001',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        'https://www.wsj.com/xml/rss/3_7085.xml',
        'https://feeds.reuters.com/reuters/businessNews',
        'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
        'https://feeds.marketwatch.com/marketwatch/topstories/',
        'https://markets.businessinsider.com/rss/news',
        'https://www.usatoday.com/rss/news/',
        'https://feeds.bloomberg.com/news.rss',
        'https://feeds.bloomberg.com/markets/news.rss'
      ],
      GLOBAL: [
        'https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en',
        'https://feeds.bbci.co.uk/news/rss.xml',
        'https://feeds.reuters.com/reuters/topNews',
        'https://feeds.reuters.com/reuters/worldNews',
        'https://rss.cnn.com/rss/cnn_topstories.rss',
        'https://rss.nytimes.com/services/xml/rss/nyt/World.xml',
        'https://www.theguardian.com/world/rss',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://apnews.com/hub/ap-top-news?utm_source=ap_rss&utm_medium=rss&utm_campaign=ap_top_news',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        'https://www.wsj.com/xml/rss/3_7085.xml',
        'https://feeds.bloomberg.com/news.rss'
      ],
      FIN: [
        'https://feeds.reuters.com/reuters/businessNews',
        'https://www.ft.com/markets?format=rss',
        'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
        'https://feeds.marketwatch.com/marketwatch/topstories/',
        'https://www.cnbc.com/id/10001147/device/rss/rss.html',
        'https://www.theguardian.com/business/markets/rss',
        'http://finance.yahoo.com/rss/topstories',
        'https://finance.yahoo.com/news/rssindex',
        'https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=en-US&gl=US&ceid=US:en',
        'https://news.google.com/rss/search?q=stock%20market%20OR%20stocks%20OR%20%22S%26P%20500%22&hl=en-US&gl=US&ceid=US:en',
        'https://www.nasdaq.com/feed/rssoutbound?category=Markets',
        'https://www.nasdaq.com/feed/rssoutbound?category=Investing',
        'https://www.investing.com/rss/news.rss',
        'https://www.investing.com/rss/news_285.rss',
        'https://www.investing.com/rss/news_25.rss',
        'https://feeds.bloomberg.com/markets/news.rss',
        'https://www.economist.com/finance-and-economics/rss.xml',
        'https://seekingalpha.com/feed.xml',
        'https://news.google.com/rss/search?q=site%3Afinance.yahoo.com&hl=en-US&gl=US&ceid=US:en'
      ]
    };

    const feedsFor = (ed) => {
      if (ed === 'ALL') {
        const merged = [].concat(...Object.values(FEEDS));
        return Array.from(new Set(merged));
      }
      return FEEDS[ed] || FEEDS.GLOBAL;
    };

    const proxyCandidates = (url) => ([
      `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      `https://r.jina.ai/http/${url.replace(/^https?:\/\//,'')}`,
      `https://r.jina.ai/http/https://r.jina.ai/http/${url.replace(/^https?:\/\//,'')}`
    ]);

    const BRAND_HINTS = {
      'news.google.com':'https://logo.clearbit.com/google.com',
      'bbc.co.uk':'https://logo.clearbit.com/bbc.co.uk',
      'bbc.com':'https://logo.clearbit.com/bbc.com',
      'reuters.com':'https://logo.clearbit.com/reuters.com',
      'cnn.com':'https://logo.clearbit.com/cnn.com',
      'nytimes.com':'https://logo.clearbit.com/nytimes.com',
      'theguardian.com':'https://logo.clearbit.com/theguardian.com',
      'aljazeera.com':'https://logo.clearbit.com/aljazeera.com',
      'apnews.com':'https://logo.clearbit.com/apnews.com',
      'cbc.ca':'https://logo.clearbit.com/cbc.ca',
      'ctvnews.ca':'https://logo.clearbit.com/ctvnews.ca',
      'globalnews.ca':'https://logo.clearbit.com/globalnews.ca',
      'nationalpost.com':'https://logo.clearbit.com/nationalpost.com',
      'cnbc.com':'https://logo.clearbit.com/cnbc.com',
      'ft.com':'https://logo.clearbit.com/ft.com',
      'wsj.com':'https://logo.clearbit.com/wsj.com',
      'npr.org':'https://logo.clearbit.com/npr.org',
      'theglobeandmail.com':'https://logo.clearbit.com/theglobeandmail.com',
      'marketwatch.com':'https://logo.clearbit.com/marketwatch.com',
      'finance.yahoo.com':'https://logo.clearbit.com/yahoo.com',
      'nasdaq.com':'https://logo.clearbit.com/nasdaq.com',
      'investing.com':'https://logo.clearbit.com/investing.com',
      'bloomberg.com':'https://logo.clearbit.com/bloomberg.com',
      'economist.com':'https://logo.clearbit.com/economist.com',
      'seekingalpha.com':'https://logo.clearbit.com/seekingalpha.com',
      'businessinsider.com':'https://logo.clearbit.com/businessinsider.com',
      'usatoday.com':'https://logo.clearbit.com/usatoday.com'
    };

    /* ===== UTILS ===== */
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const timeAgo = (d)=>{
      const now = new Date();
      const diff = Math.max(0, now - d);
      const sec = Math.floor(diff/1000);
      if (sec<45) return `${sec}s ago`;
      const min = Math.floor(sec/60);
      if (min<60) return `${min}m ago`;
      const hr = Math.floor(min/60);
      if (hr<24) return `${hr}h ago`;
      const day = Math.floor(hr/24);
      return `${day}d ago`;
    };
    const cleanLink = (url)=>{
      try{
        const u = new URL(url);
        const wrapped = u.searchParams.get('url') || u.searchParams.get('u');
        return wrapped ? decodeURIComponent(wrapped) : url;
      }catch{ return url }
    };
    const hostname = (url)=>{ try{ return new URL(url).hostname.replace(/^www\./,'') } catch{ return '' } };
    const absolutize = (src, base)=>{
      try{
        if(!src) return '';
        if (src.startsWith('data:')) return '';
        if (/^https?:\/\//i.test(src)) return src;
        if (src.startsWith('//')) return (new URL(base)).protocol + src;
        return new URL(src, base).toString();
      }catch{ return src }
    };
    const normalizeTitle = (t)=> t.toLowerCase().replace(/[\W_]+/g,' ').trim();
    const pick = (el, sel)=> el.querySelector(sel)?.getAttribute('content')?.trim() || el.querySelector(sel)?.textContent?.trim();
    const getAttr = (el, sel, attr)=> el.querySelector(sel)?.getAttribute(attr);

    const brandSources = (host)=>{
      const base = BRAND_HINTS[host] || `https://logo.clearbit.com/${host}`;
      return {
        src: `${base}?size=512`,
        srcset: `${base}?size=64 64w, ${base}?size=128 128w, ${base}?size=256 256w, ${base}?size=512 512w`,
        s2: `https://www.google.com/s2/favicons?domain=${host}&sz=256`
      };
    };
    const brandLogoHTML = (host, className = '', alt = '')=>{
      const b = brandSources(host);
      return `<img loading="lazy" decoding="async" src="${b.src}" srcset="${b.srcset}" sizes="(max-width:640px) 50vw, 33vw" data-alt1="${b.s2}" data-host="${host}" alt="${alt || host}" class="${className} brand-fb">`;
    };
    const brandBadgeHTML = (host, size=14)=>{
      const b = brandSources(host);
      return `<img loading="lazy" decoding="async" src="${b.src}" srcset="${b.srcset}" data-alt1="${b.s2}" data-host="${host}" alt="${host}" class="inline-block rounded-[3px] align-[-2px] brand-fb" style="height:${size}px;width:${size}px">`;
    };
    const hostLinkHTML = (url)=>{
      const h = hostname(url) || 'source';
      return `<a href="${url}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 hover:underline decoration-[var(--accent)]/40 underline-offset-4 text-[var(--sub)]">${brandBadgeHTML(h,14)}<span>${h}</span></a>`;
    };

    /* Apple-style placeholder (never show logos in big slots) */
    const noImageHTML = (className='')=>`<div class="noimg ${className.replace(/object-\S+/g,'')}" aria-label="No image available"><span>No Image Found</span></div>`;

    const letterTileHTML = (label='?', className='')=>`
      <div class="w-full h-full grid place-items-center bg-[var(--surface)] ${className}">
        <span class="text-xs sm:text-sm font-semibold" style="color: var(--sub)">${label.slice(0,3).toUpperCase()}</span>
      </div>
    `;
    const upscaleImageUrl = (u)=>{
      try{
        let url = new URL(u);
        ['w','width','maxwidth','px','param','imgw'].forEach(k=>{ if (url.searchParams.has(k)) url.searchParams.set(k,'1600'); });
        return url.toString();
      }catch{ return u.replace(/([?&])(w|width|maxwidth|px)=\d+/gi,'$1$2=1600'); }
    };

    /* ===== IMAGE PIPELINE (fast) ===== */
    const IMG_PROXY = 'https://wsrv.nl';
    const proxyImage = (u,w=1280)=> `${IMG_PROXY}/?url=${encodeURIComponent(u)}&w=${w}&output=webp`;
    const makeSrcset = (u,widths=[360,540,720,960,1200,1440,1800])=> widths.map(w=>`${proxyImage(u,w)} ${w}w`).join(', ');
    const prepareImage = (u)=> {
      const src = upscaleImageUrl(u);
      return { src: proxyImage(src, 1200), srcset: makeSrcset(src) };
    };

    let lazyObs=null;
    function setupLazyObserver(){
      if(!('IntersectionObserver' in window)) return;
      lazyObs = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            const img = entry.target;
            if (img.dataset.src){ img.src = img.dataset.src; }
            if (img.dataset.srcset){ img.srcset = img.dataset.srcset; }
            img.loading = 'lazy'; img.decoding = 'async';
            img.removeAttribute('data-src'); img.removeAttribute('data-srcset');
            lazyObs.unobserve(img);
          }
        });
      }, { rootMargin:'300px 0px' });
    }
    function observeAllLazy(root=document){
      if (!lazyObs) return;
      root.querySelectorAll('img.lazy-img').forEach(im=> lazyObs.observe(im));
    }

    /* ===== RSS + IMAGE RESOLUTION ===== */
    const parseRSS = (text)=>{
      const tryXML = ()=>{
        const dom = new DOMParser().parseFromString(text, 'text/xml');
        return dom.querySelector('parsererror') ? null : dom;
      };
      const dom = tryXML();
      if(!dom){
        const items = [];
        const blocks = text.split(/<\/item>/i);
        for(const b of blocks){
          const t  = (b.match(/<title>([^<]+)<\/title>/i) || ['', '' ])[1];
          const lk = cleanLink((b.match(/<link>([^<]+)<\/link>/i) || ['', '' ])[1]);
          const pd = (b.match(/<pubDate>([^<]+)<\/pubDate>/i) || ['', '' ])[1];
          const sc = (b.match(/<source[^>]*>([^<]+)<\/source>/i) || ['', '' ])[1];
          const img = (b.match(/<media:content[^>]*url="([^"]+)"/i) || b.match(/<enclosure[^>]*url="([^"]+)"/i) || ['', '' ])[1];
          if(t && lk) items.push({title:t, link:lk, pubDate: pd?new Date(pd):new Date(), source: sc||hostname(lk), image: img||''});
        }
        return items;
      }else{
        const items = [];
        dom.querySelectorAll('item').forEach(it=>{
          const title = pick(it,'title') || '';
          let link = pick(it,'link') || '';
          link = cleanLink(link);
          const pub  = pick(it,'pubDate') || '';
          const src  = pick(it,'source') || '';
          const img1 = getAttr(it,'media\\:content','url');
          const img2 = getAttr(it,'enclosure','url');
          items.push({ title, link, pubDate: pub ? new Date(pub) : new Date(), source: src || hostname(link), image: img1 || img2 || '' });
        });
        return items;
      }
    };

    const fetchWithProxies = async (url)=>{
      for (const prox of proxyCandidates(url)){
        try{
          const res = await fetch(prox, { cache: 'no-store' });
          if(!res.ok) continue;
          const text = await res.text();
          if(text && text.length > 40) return text;
        }catch(_){ }
      }
      throw new Error('All proxies failed for ' + url);
    };

    const IMG_CACHE = new Map();
    const resolving = new Set();

    const tryFindOgImage = (html, baseUrl)=>{
      try{
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const tryMeta = (sel)=> absolutize(pick(doc, sel), baseUrl);
        const cands = [
          'meta[property="og:image:secure_url"]',
          'meta[property="og:image:url"]',
          'meta[property="og:image"]',
          'meta[name="og:image"]',
          'meta[name="twitter:image:src"]',
          'meta[name="twitter:image"]',
          'meta[itemprop="image"]'
        ];
        for(const sel of cands){
          const u = tryMeta(sel); if(u) return u;
        }
        const linkImg = doc.querySelector('link[rel="image_src"]');
        if (linkImg){
          const href = linkImg.getAttribute('href');
          const u = absolutize(href, baseUrl); if (u) return u;
        }
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for(const s of scripts){
          try{
            const data = JSON.parse(s.textContent.trim());
            const collect = (obj)=>{
              if(!obj) return null;
              if(typeof obj === 'string') return absolutize(obj, baseUrl);
              if(Array.isArray(obj)){
                for(const it of obj){ const inner = collect(it); if(inner) return inner; }
              }else if(typeof obj === 'object'){
                if(obj.url && typeof obj.url === 'string' && /(\.jpe?g|\.png|\.webp|\.gif)(\?|$)/i.test(obj.url)) return absolutize(obj.url, baseUrl);
                if(obj.image) return collect(obj.image);
                if(obj.thumbnailUrl) return absolutize(obj.thumbnailUrl, baseUrl);
                if(obj.logo) return collect(obj.logo);
              }
              return null;
            };
            const found = collect(data); if(found) return found;
          }catch{}
        }
        const imgs = Array.from(doc.querySelectorAll('img'));
        for(const im of imgs){
          const src = absolutize(im.getAttribute('src') || im.getAttribute('data-src') || '', baseUrl);
          if(!src) continue;
          const w = parseInt(im.getAttribute('width')||'0',10);
          const h = parseInt(im.getAttribute('height')||'0',10);
          if ((w>=300 || h>=200) || /[\/-](hero|lead|feature|main|large|og|share)[-_.]/i.test(src)) return src;
        }
      }catch{}
      return '';
    };

    const resolveArticleImage = async (url)=>{
      if(!url) return '';
      if(IMG_CACHE.has(url)) return IMG_CACHE.get(url);
      if(resolving.has(url)) return '';
      resolving.add(url);
      try{
        const html = await fetchWithProxies(url);
        const img = tryFindOgImage(html, url) || '';
        const better = img ? upscaleImageUrl(img) : '';
        IMG_CACHE.set(url, better);
        return better;
      }catch{
        IMG_CACHE.set(url, '');
        return '';
      }finally{ resolving.delete(url) }
    };

    const improveImagesFor = async (items, limit=12)=>{
      const targets = items.filter(it=>!it.image).slice(0, limit);
      let updated = false;
      await Promise.all(targets.map(async (it)=>{
        const best = await resolveArticleImage(it.link);
        if(best){ it.image = best; updated = true; }
      }));
      if(updated){ applyFilter(); }
    };

    const loadFeeds = async (editionKey)=>{
      const feeds = feedsFor(editionKey);
      const all = [];
      await Promise.allSettled(
        feeds.map(async (f)=>{
          try{
            const text = await fetchWithProxies(f);
            const items = parseRSS(text);
            all.push(...items);
          }catch(_){ }
        })
      );
      const seen = new Map(); // normTitle -> { item, count }
      for(const it of all){
        const key = normalizeTitle(it.title);
        if(!key) continue;
        const prev = seen.get(key);
        if(!prev){ seen.set(key, { item: it, count: 1 }); }
        else{
          if (it.pubDate && prev.item.pubDate && it.pubDate > prev.item.pubDate) prev.item = it;
          prev.count++;
        }
      }
      let uniq = Array.from(seen.values()).map(({item, count})=> ({...item, trendCount: count}));
      const now = Date.now();
      uniq.forEach(u=>{
        const ageMin = Math.max(1, (now - (u.pubDate?.getTime?.()||now))/60000);
        u._score = (u.trendCount||1) * (1/ageMin);
        if (u.image) u.image = upscaleImageUrl(u.image);
      });
      uniq.sort((a,b)=> (b._score - a._score) || ((b.pubDate||0) - (a.pubDate||0)));
      return uniq.slice(0, MAX_ITEMS);
    };

    /* ===== BOOKMARKS ===== */
    const SAVED_KEY = 'oc_news_saved';
    const getSaved = ()=>{ try{ return JSON.parse(localStorage.getItem(SAVED_KEY)||'[]') }catch{ return [] } };
    const setSaved = (arr)=> localStorage.setItem(SAVED_KEY, JSON.stringify(arr.slice(0,200)));
    const isSaved = (link)=> getSaved().some(x=>x.link===link);
    const toggleSave = (item)=>{
      const cur = getSaved();
      const idx = cur.findIndex(x=>x.link===item.link);
      if(idx>=0){ cur.splice(idx,1) } else { cur.unshift({ ...item, savedAt: Date.now() }) }
      setSaved(cur);
    };

    /* ===== RENDER (NEWS) ===== */
    const heroTrack = $('#heroTrack');
    const heroDots  = $('#heroDots');
    const updatedAt = $('#updatedAt');
    const newsList  = $('#newsList');
    const ticker    = $('#ticker');
    const trendingRail = $('#trendingRail');

    // Controls
    const themeBtn = $('#themeBtn');
    const prevTopBtn = $('#prevTopBtn');
    const nextTopBtn = $('#nextTopBtn');
    const weatherBtn = $('#weatherBtn'); const weatherBtnMobile = $('#weatherBtnMobile');

    // Route
    const newsMain = $('#newsMain'); const weatherMain = $('#weatherMain');
    const newsTab = $('#newsTab'); const weatherTab = $('#weatherTab'); // may be null

    // Date badge
    const todayBadge = document.getElementById('todayBadge');
    if (todayBadge){
      const dt = new Date();
      todayBadge.textContent = dt.toLocaleDateString([], { weekday:'short', month:'short', day:'numeric' });
      todayBadge.setAttribute('aria-label', dt.toLocaleDateString([], { weekday:'long', month:'long', day:'numeric', year:'numeric' }));
    }

    let showingSaved = false;
    let currentEdition = DEFAULT_EDITION;
    let cacheItems = [];
    let filteredItems = [];
    let cycleIdx = 0;
    let cycleTimer = null;

    const applySort = ()=>{
      const arr = filteredItems.slice();
      if (sortMode === SORT_MODES.NEWEST) arr.sort((a,b)=>(b.pubDate||0)-(a.pubDate||0));
      else if (sortMode === SORT_MODES.OLDEST) arr.sort((a,b)=>(a.pubDate||0)-(b.pubDate||0));
      else if (sortMode === SORT_MODES.SOURCE) arr.sort((a,b)=>(a.source||hostname(a.link)||'').localeCompare(b.source||hostname(b.link)||''));
      filteredItems = arr;
    };

    const applyFilter = ()=>{
      const base = showingSaved ? getSaved() : cacheItems;
      filteredItems = base.slice();
      applySort();
      render(filteredItems);
    };

    const renderTicker = (_items)=>{ /* no-op; #tickerWrap hidden */ };

    const buildHeroSlides = (items)=>{
      const list = items.slice(0, Math.min(HERO_SLIDES, items.length));
      heroTrack.innerHTML = list.map((it, idx)=>{
        const host = hostname(it.link) || 'news.google.com';
        const src  = (SHOW_IMAGES && it.image) ? it.image : '';
        const safeTitle = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        let mediaHTML='';
        if (src){
          const prep = prepareImage(src);
          if (idx === 0){
            // First hero → priority for LCP
            mediaHTML = `<img fetchpriority="high" loading="eager" decoding="async" src="${prep.src}" srcset="${prep.srcset}" sizes="100vw" alt="${safeTitle}" class="brand-fb" data-host="${host}" data-kind="content">`;
          } else {
            mediaHTML = `<img class="brand-fb lazy-img" fetchpriority="low" loading="lazy" decoding="async" data-src="${prep.src}" data-srcset="${prep.srcset}" sizes="100vw" alt="${safeTitle}" data-host="${host}" data-kind="content">`;
          }
        } else {
          mediaHTML = noImageHTML('');
        }
        return `
          <div class="hero-slide" data-index="${idx}" data-link="${it.link}">
            <a href="${it.link}" target="_blank" rel="noopener" aria-label="${safeTitle}"></a>
            ${mediaHTML}
            <div class="hero-overlay-text">
              <div class="hero-glass">
                <div class="k inline-flex items-center gap-2">${brandBadgeHTML(host,12)}<span>${host}</span> • ${timeAgo(it.pubDate)}</div>
                <h2>${safeTitle}</h2>
              </div>
            </div>
          </div>
        `;
      }).join('');
      const dcount = Math.min(DOT_COUNT, Math.max(1, list.length));
      heroDots.innerHTML = Array.from({ length: dcount }).map((_,i)=>`<span class="${i===0?'active':''}"></span>`).join('');
      // Observe lazy hero images (except first)
      observeAllLazy(heroTrack);
    };

    const setHeroMetaFromIndex = (idx)=>{
      if(!filteredItems.length) return;
      const children = Array.from(heroDots.children);
      if (children.length){
        const dotIndex = Math.min(children.length-1, idx % children.length);
        children.forEach((d,i)=>d.classList.toggle('active', i===dotIndex));
      }
    };

    const renderTrending = (items)=>{
      if(!items.length){ trendingRail.innerHTML = ''; return; }
      const top = items.slice().sort((a,b)=> (b.trendCount - a.trendCount) || ((b.pubDate||0)-(a.pubDate||0))).slice(0,12);
      trendingRail.innerHTML = top.map(it=>{
        const host = hostname(it.link);
        const safeTitle = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        let media = '';
        if (it.image){
          const prep = prepareImage(it.image);
          media =
            `<img class="w-full h-44 object-cover rounded-md brand-fb lazy-img" fetchpriority="low" loading="lazy" decoding="async"
                  data-src="${prep.src}" data-srcset="${prep.srcset}" sizes="(max-width:640px) 100vw, 33vw"
                  data-host="${host}" data-kind="content" alt="${safeTitle}">`;
        } else {
          media = noImageHTML('w-full h-44 rounded-md');
        }
        return `
          <article class="card p-3 sm:p-4 cv-auto">
            <a href="${it.link}" target="_blank" rel="noopener" class="block mb-3 rounded-md overflow-hidden">${media}</a>
            <div class="flex items-center justify-between gap-3 text-[11px] text-[var(--sub)] mb-1">
              <span>${timeAgo(it.pubDate)}</span>
              ${hostLinkHTML(it.link)}
            </div>
            <a href="${it.link}" target="_blank" rel="noopener" class="block">
              <h3 class="text-sm sm:text-base font-semibold leading-snug hover:underline decoration-[var(--accent)]/60 underline-offset-4">${safeTitle}</h3>
            </a>
          </article>
        `;
      }).join('');
      observeAllLazy(trendingRail);
    };

    // ---------- Apple-style tile layout ----------
    const render = (items)=>{
      if(!items || !items.length){
        newsList.innerHTML = ''; ticker.innerHTML = ''; heroTrack.innerHTML = ''; heroDots.innerHTML = '';
        trendingRail.innerHTML = '';
        return;
      }
      if (cycleIdx >= items.length) cycleIdx = 0;

      buildHeroSlides(items);
      setHeroMetaFromIndex(cycleIdx);
      updatedAt.textContent = `Updated ${new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}`;
      renderTicker(items);

      const tiles = items.slice(1, 20);

      let html = '';
      tiles.forEach((it, idx)=>{
        const when = timeAgo(it.pubDate);
        const host = hostname(it.link);
        const saved = isSaved(it.link);
        const safeTitle = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const vertical = idx < 2;

        if (vertical){
          let media = '';
          if (SHOW_IMAGES && it.image){
            const prep = prepareImage(it.image);
            media = `<img class="tile-img w-full h-[300px] sm:h-[360px] object-cover brand-fb lazy-img" fetchpriority="low" loading="lazy" decoding="async"
                        data-src="${prep.src}" data-srcset="${prep.srcset}" sizes="(max-width:640px) 100vw, 50vw"
                        data-host="${host}" data-kind="content" alt="${safeTitle}">`;
          } else {
            media = noImageHTML('tile-img w-full h-[300px] sm:h-[360px]');
          }
          html += `
            <li class="col-span-1">
              <article class="card overflow-hidden cv-auto">
                <a href="${it.link}" target="_blank" rel="noopener" class="block">${media}</a>
                <div class="p-3 sm:p-4">
                  <div class="flex items-center justify-between gap-3 text-[11px] text-[var(--sub)] mb-1">
                    ${hostLinkHTML(it.link)}<span>${when}</span>
                  </div>
                  <a href="${it.link}" target="_blank" rel="noopener" class="block">
                    <h3 class="text-base sm:text-lg font-extrabold leading-snug text-balance hover:underline decoration-[var(--accent)]/60 underline-offset-4">${safeTitle}</h3>
                  </a>
                  <div class="mt-3">
                    <button data-save='${encodeURIComponent(JSON.stringify(it))}' data-link="${it.link}" class="saveBtn text-[11px] chip rounded px-2 py-1">${saved ? 'Saved' : 'Save'}</button>
                  </div>
                </div>
              </article>
            </li>
          `;
        } else {
          let media = '';
          if (SHOW_IMAGES && it.image){
            const prep = prepareImage(it.image);
            media = `<img class="w-full h-full object-cover brand-fb lazy-img" fetchpriority="low" loading="lazy" decoding="async"
                        data-src="${prep.src}" data-srcset="${prep.srcset}" sizes="(max-width:640px) 100vw, 44vw"
                        data-host="${host}" data-kind="content" alt="${safeTitle}">`;
          } else {
            media = noImageHTML('w-full h-full');
          }
          html += `
            <li class="col-span-2">
              <article class="card p-3 sm:p-4 flex items-stretch gap-3 sm:gap-4 cv-auto">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center justify-between gap-3 text-[11px] text-[var(--sub)] mb-1">
                    ${hostLinkHTML(it.link)}<span>${when}</span>
                  </div>
                  <a href="${it.link}" target="_blank" rel="noopener" class="block">
                    <h3 class="text-[17px] sm:text-xl font-extrabold leading-snug text-balance hover:underline decoration-[var(--accent)]/60 underline-offset-4">${safeTitle}</h3>
                  </a>
                  <div class="mt-3">
                    <button data-save='${encodeURIComponent(JSON.stringify(it))}' data-link="${it.link}" class="saveBtn text-[11px] chip rounded px-2 py-1">${saved ? 'Saved' : 'Save'}</button>
                  </div>
                </div>
                <a href="${it.link}" target="_blank" rel="noopener" class="shrink-0 w-[44%] sm:w-[300px] aspect-[16/10] rounded-xl overflow-hidden">
                  ${media}
                </a>
              </article>
            </li>
          `;
        }
      });

      newsList.innerHTML = html;

      $$('.saveBtn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const raw = decodeURIComponent(e.currentTarget.getAttribute('data-save')||'%7B%7D');
          try{ toggleSave(JSON.parse(raw)); applyFilter(); }catch{}
        });
      });

      renderTrending(items);

      // Defer image improvement to idle time
      const ridle = window.requestIdleCallback || ((fn)=> setTimeout(fn, 180));
      ridle(()=> {
        improveImagesFor(items.slice(0, HERO_SLIDES), HERO_SLIDES).then(()=>{});
        improveImagesFor(items.slice(HERO_SLIDES), 18);
      });

      // Observe new lazy images
      observeAllLazy(newsList);
    };
    // ---------- END tile layout ----------

    /* ===== THEME ===== */
    const sunIcon = document.getElementById('sun');
    const moonIcon = document.getElementById('moon');
    const THEME_KEY = 'oc_theme';
    const resolveAutoTheme = ()=> window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    const setTheme = (mode)=>{
      document.documentElement.dataset.theme = mode;
      const final = (mode === 'auto') ? resolveAutoTheme() : mode;
      document.documentElement.classList.toggle('light', final === 'light');
      document.documentElement.classList.toggle('dark',  final === 'dark');
      localStorage.setItem(THEME_KEY, mode);
      sunIcon.classList.toggle('hidden', final !== 'light');
      moonIcon.classList.toggle('hidden', final !== 'dark');
    };
    const cycleTheme = ()=>{
      const cur = localStorage.getItem(THEME_KEY) || 'auto';
      const next = cur === 'auto' ? 'dark' : (cur === 'dark' ? 'light' : 'auto');
      setTheme(next);
    };

    /* ===== WEATHER ===== */
    const wxQuery = $('#wxQuery');
    const wxMyLocation = $('#wxMyLocation');
    const wxMeta = $('#wxMeta');
    const wxPlace = $('#wxPlace');
    const wxDesc = $('#wxDesc');
    const wxTemp = $('#wxTemp');
    const wxFeels = $('#wxFeels');
    const wxHum = $('#wxHum');
    const wxWind = $('#wxWind');
    const wxPrec = $('#wxPrec');
    const wxUV = $('#wxUV');
    const wxHourly = $('#wxHourly');
    const wxDaily = $('#wxDaily');

    const WX_STORE = 'oc_wx_last';
    const saveWx = (obj)=> localStorage.setItem(WX_STORE, JSON.stringify(obj||{}));
    const getWx = ()=>{ try{ return JSON.parse(localStorage.getItem(WX_STORE)||'{}') }catch{ return {} } };

    const fmt = (n,unit='')=> (Number.isFinite(n) ? `${Math.round(n)}${unit}` : '—');
    const degToDir = (deg)=>{
      if(!Number.isFinite(deg)) return '—';
      const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round(deg/22.5)%16];
    };

    const wxCodeToText = (code)=>{
      const map = {
        0:'Clear',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',
        45:'Fog',48:'Depositing rime fog',
        51:'Light drizzle',53:'Drizzle',55:'Dense drizzle',
        61:'Light rain',63:'Rain',65:'Heavy rain',
        66:'Freezing rain',67:'Heavy freezing rain',
        71:'Light snow',73:'Snow',75:'Heavy snow',
        80:'Rain showers',81:'Rain showers',82:'Violent rain showers',
        85:'Snow showers',86:'Snow showers',
        95:'Thunderstorm',96:'Thunderstorm',99:'Severe thunderstorm'
      };
      return map[code] || '—';
    };

    const geocode = async (q)=>{
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en&format=json`;
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('Geocoding failed');
      const j = await res.json();
      const r = j.results?.[0];
      if(!r) throw new Error('Place not found');
      return { name: `${r.name}${r.admin1?`, ${r.admin1}`:''}${r.country?`, ${r.country}`:''}`, lat:r.latitude, lon:r.longitude };
    };

    const fetchForecast = async ({ lat, lon })=>{
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      const params = {
        latitude: lat, longitude: lon, current: 'temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m,uv_index',
        hourly: 'temperature_2m,precipitation_probability,weather_code',
        daily: 'temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max,weather_code',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('Forecast failed');
      return res.json();
    };

    // --- Apple-like Weather FX (canvas + tilt + reveals) ---
    let wxFx = { canvas:null, ctx:null, raf:0, kind:null, particles:[] };
    const ensureWxCanvas = ()=>{
      const card = document.getElementById('wxNowCard');
      let c = document.getElementById('wxFx');
      if(!c){
        c = document.createElement('canvas');
        c.id = 'wxFx';
        card.prepend(c);
      }
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      const rect = card.getBoundingClientRect();
      c.width = Math.floor(rect.width*dpr);
      c.height = Math.floor((rect.height)*dpr);
      c.style.width = rect.width+'px';
      c.style.height = rect.height+'px';
      wxFx.canvas = c; wxFx.ctx = c.getContext('2d'); wxFx.ctx.setTransform(dpr,0,0,dpr,0,0);
    };
    const stopWxFx = ()=>{ if(wxFx.raf) cancelAnimationFrame(wxFx.raf); wxFx.raf=0; wxFx.particles=[]; wxFx.kind=null; if(wxFx.ctx){ wxFx.ctx.clearRect(0,0,wxFx.canvas.width,wxFx.canvas.height); } };

    const startRain = ()=>{
      wxFx.kind='rain'; wxFx.particles = Array.from({length: 160}, ()=> ({
        x: Math.random()*wxFx.canvas.clientWidth, y: Math.random()*wxFx.canvas.clientHeight,
        l: 8+Math.random()*14, v: 2+Math.random()*3
      }));
      const step = ()=>{
        const w = wxFx.canvas.clientWidth, h = wxFx.canvas.clientHeight, ctx = wxFx.ctx;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle = 'rgba(180,200,255,0.55)';
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        for(const p of wxFx.particles){
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p.x-3, p.y+p.l);
          p.x -= 1.6; p.y += p.v+3;
          if (p.y > h || p.x < -10){ p.x = Math.random()*w+20; p.y = -20; }
        }
        ctx.stroke();
        wxFx.raf = requestAnimationFrame(step);
      };
      step();
    };
    const startSnow = ()=>{
      wxFx.kind='snow'; wxFx.particles = Array.from({length: 120}, ()=> ({
        x: Math.random()*wxFx.canvas.clientWidth, y: Math.random()*wxFx.canvas.clientHeight,
        r: 1+Math.random()*2.8, v: .4+Math.random()*1.2, drift: (Math.random()-.5)*0.6
      }));
      const step = ()=>{
        const w = wxFx.canvas.clientWidth, h = wxFx.canvas.clientHeight, ctx = wxFx.ctx;
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        for(const p of wxFx.particles){
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
          p.x += p.drift; p.y += p.v;
          if (p.y > h){ p.y = -10; p.x = Math.random()*w; }
          if (p.x < -10) p.x = w+10; if (p.x > w+10) p.x = -10;
        }
        wxFx.raf = requestAnimationFrame(step);
      };
      step();
    };
    const startSun = ()=>{
      wxFx.kind='sun';
      const ctx = wxFx.ctx, w = wxFx.canvas.clientWidth, h = wxFx.canvas.clientHeight;
      let t=0;
      const step = ()=>{
        ctx.clearRect(0,0,w,h);
        const cx = w-90, cy = 90, r = 40;
        const g = ctx.createRadialGradient(cx,cy,0,cx,cy,r*2.2);
        g.addColorStop(0,'rgba(255,215,120,0.9)');
        g.addColorStop(1,'rgba(255,215,120,0.0)');
        ctx.fillStyle = g; ctx.beginPath(); ctx.arc(cx,cy,r*2.2,0,Math.PI*2); ctx.fill();

        // Rays
        ctx.save();
        ctx.translate(cx,cy); ctx.rotate(t/180*Math.PI);
        ctx.strokeStyle = 'rgba(255,230,150,0.9)'; ctx.lineWidth = 2;
        for(let i=0;i<12;i++){
          ctx.rotate(Math.PI/6);
          ctx.beginPath(); ctx.moveTo(r+6,0); ctx.lineTo(r+22,0); ctx.stroke();
        }
        ctx.restore();

        // Subtle bokeh
        ctx.globalAlpha = 0.08;
        for (let i=0;i<10;i++){
          const bx = (i*83 + t*1.7) % (w+200) - 100;
          const by = 40 + (i*37 % (h*0.6));
          const br = 18 + (i*7 % 28);
          const bg = ctx.createRadialGradient(bx,by,0,bx,by,br);
          bg.addColorStop(0,'#fff'); bg.addColorStop(1,'transparent');
          ctx.fillStyle = bg; ctx.beginPath(); ctx.arc(bx,by,br,0,Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;

        t += .6;
        wxFx.raf = requestAnimationFrame(step);
      };
      step();
    };
    const startThunder = ()=>{
      wxFx.kind='thunder';
      startRain();
      const flash = ()=>{
        const ctx2 = wxFx.ctx, w = wxFx.canvas.clientWidth, h = wxFx.canvas.clientHeight;
        if (Math.random() < 0.06){
          ctx2.save();
          ctx2.fillStyle = 'rgba(255,255,255,0.22)';
          ctx2.fillRect(0,0,w,h);
          ctx2.restore();
          setTimeout(()=>{}, 80);
        }
        setTimeout(flash, 350+Math.random()*1200);
      };
      flash();
    };
    const startClouds = ()=>{
      wxFx.kind='clouds';
      wxFx.particles = Array.from({length: 14}, ()=> ({
        x: Math.random()*wxFx.canvas.clientWidth,
        y: 20 + Math.random()*90,
        r: 30 + Math.random()*60,
        v: .12 + Math.random()*.25,
        a: .08 + Math.random()*.10
      }));
      const step = ()=>{
        const w = wxFx.canvas.clientWidth, h = wxFx.canvas.clientHeight, ctx = wxFx.ctx;
        ctx.clearRect(0,0,w,h);
        for(const p of wxFx.particles){
          const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r);
          g.addColorStop(0,`rgba(210,220,235,${p.a})`);
          g.addColorStop(1,'rgba(210,220,235,0)');
          ctx.fillStyle = g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
          p.x += p.v; if (p.x - p.r > w+40){ p.x = -p.r-40; p.y = 20 + Math.random()*110; }
        }
        wxFx.raf = requestAnimationFrame(step);
      };
      step();
    };

    const renderWxFXForCode = (code)=>{
      stopWxFx();
      ensureWxCanvas();
      if ([61,63,65,80,81,82,66,67].includes(code)) { startRain(); return; }
      if ([71,73,75,85,86].includes(code)) { startSnow(); return; }
      if ([95,96,99].includes(code)) { startThunder(); return; }
      if ([0,1].includes(code)) { startSun(); return; }
      if ([2,3,45,48].includes(code)) { startClouds(); return; }
    };
    window.addEventListener('resize', ()=>{ if(wxFx.canvas){ ensureWxCanvas(); if (wxFx.kind) renderWxFXForCode(wxFx.kind); } });

    // Tilt/parallax on weather card
    let tiltBound = false;
    function bindWxTilt(){
      if (tiltBound) return; tiltBound = true;
      const card = document.getElementById('wxNowCard');
      card.addEventListener('pointermove', (e)=>{
        const r = card.getBoundingClientRect();
        const cx = r.left + r.width/2, cy = r.top + r.height/2;
        const dx = (e.clientX - cx)/r.width;   // -0.5..0.5
        const dy = (e.clientY - cy)/r.height;  // -0.5..0.5
        const rx = (-dy * 4).toFixed(2);
        const ry = ( dx * 6).toFixed(2);
        card.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(0)`;
        card.style.boxShadow = `0 24px 80px -28px rgba(0,0,0,.35)`;
      });
      card.addEventListener('pointerleave', ()=>{
        card.style.transform = `perspective(900px) rotateX(0deg) rotateY(0deg)`;
        card.style.boxShadow = '';
      });
    }

    // Reveal helper
    function revealWxBits(){
      ['#wxPlace','#wxDesc','#wxTemp','#wxFeels'].forEach(sel=>{
        const el = document.querySelector(sel); if (el){ el.style.willChange='transform,opacity'; el.classList.add('animate-reveal-up'); }
      });
    }

    const loadWeather = async (place)=>{
      try{
        wxMeta.textContent = 'Loading…';
        const j = await fetchForecast(place);
        const cur = j.current;
        const name = place.name || `${place.lat.toFixed(3)}, ${place.lon.toFixed(3)}`;

        wxPlace.textContent = name;
        wxDesc.textContent = wxCodeToText(cur.weather_code);
        wxTemp.textContent = fmt(cur.temperature_2m,'°');
        wxFeels.textContent = `Feels like ${fmt(cur.apparent_temperature,'°')}`;
        wxHum.textContent = fmt(cur.relative_humidity_2m,'%');
        wxWind.textContent = `${fmt(cur.wind_speed_10m)} km/h ${degToDir(cur.wind_direction_10m)}`;
        wxPrec.textContent = fmt(cur.precipitation,' mm');
        wxUV.textContent = fmt(cur.uv_index);

        ensureWxCanvas();
        renderWxFXForCode(cur.weather_code);
        bindWxTilt();
        revealWxBits();

        wxHourly.innerHTML = '';
        const now = Date.now();
        const htimes = j.hourly.time;
        for(let i=htimes.findIndex(t=> new Date(t).getTime() >= now); i<htimes.length && wxHourly.children.length<24; i++){
          const t = new Date(htimes[i]);
          const chip = document.createElement('div');
          chip.className = 'wx-pill text-center min-w-[74px] animate-reveal-up';
          const hh = t.toLocaleTimeString([], { hour:'numeric' });
          const tt = j.hourly.temperature_2m[i];
          const pp = j.hourly.precipitation_probability[i];
          chip.style.animationDelay = (wxHourly.children.length * 0.02)+'s';
          chip.innerHTML = `<div class="text-[11px] text-[var(--sub)]">${hh}</div><div class="text-sm font-semibold">${fmt(tt,'°')}</div><div class="text-[11px]">${Number.isFinite(pp)?pp:0}%</div>`;
          wxHourly.appendChild(chip);
        }

        wxDaily.innerHTML = '';
        for(let i=0;i<Math.min(j.daily.time.length,7);i++){
          const d = new Date(j.daily.time[i]);
          const el = document.createElement('div');
          el.className = 'wx-pill flex items-center justify-between animate-reveal-up';
          el.style.animationDelay = (i*0.03)+'s';
          const w = wxCodeToText(j.daily.weather_code[i]);
          el.innerHTML = `
            <div>
              <div class="text-[11px] text-[var(--sub)]">${d.toLocaleDateString([], { weekday:'short' })}</div>
              <div class="text-sm font-semibold">${w}</div>
            </div>
            <div class="text-right">
              <div class="text-sm font-semibold">${fmt(j.daily.temperature_2m_max[i],'°')} / ${fmt(j.daily.temperature_2m_min[i],'°')}</div>
              <div class="text-[11px] text-[var(--sub)]">${fmt(j.daily.precipitation_sum[i],' mm')} • UV ${fmt(j.daily.uv_index_max[i])}</div>
            </div>
          `;
          wxDaily.appendChild(el);
        }
        wxMeta.textContent = `Updated ${new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}`;
      }catch(e){
        console.error(e);
        wxMeta.textContent = 'Could not load weather.';
      }
    };

    const resolveMyLocation = ()=> new Promise((resolve,reject)=>{
      if(!('geolocation' in navigator)) return reject(new Error('No geolocation'));
      navigator.geolocation.getCurrentPosition(
        ({ coords })=> resolve({ lat: coords.latitude, lon: coords.longitude }),
        (err)=> reject(err),
        { enableHighAccuracy:false, timeout: 8000, maximumAge: 600000 }
      );
    });

    const ensureWeatherFor = async (placeLike)=>{
      let place = placeLike;
      if (!place.name){ place.name = `${place.lat.toFixed(3)}, ${place.lon.toFixed(3)}`; }
      saveWx(place);
      await loadWeather(place);
    };

    /* ===== NAV / BOOTSTRAP ===== */
    const headerEl = document.querySelector('header');
    const setHeaderVar = ()=> document.documentElement.style.setProperty('--header-h', (headerEl?.offsetHeight || 60)+'px');
    setHeaderVar();
    window.addEventListener('resize', setHeaderVar);

    const setMobileEditionUI = ()=> { $$('.seg-btn').forEach(b=> b.classList.toggle('active', b.dataset.ed === currentEdition)); };

    // Slides
    const slideTo = (idx)=>{
      const slides = Array.from(heroTrack.children);
      if(!slides.length) return;
      const clamped = Math.max(0, Math.min(slides.length-1, idx));
      const target = slides[clamped];
      heroTrack.scrollTo({ left: target.offsetLeft, behavior: 'smooth' });
      cycleIdx = clamped % Math.max(1, filteredItems.length);
      setHeroMetaFromIndex(cycleIdx);
    };
    const nextHero = ()=> slideTo((cycleIdx + 1) % Math.max(1, filteredItems.length));
    const prevHero = ()=> slideTo((cycleIdx - 1 + Math.max(1, filteredItems.length)) % Math.max(1, filteredItems.length));

    let heroTrackScrollLock = false;
    heroTrack.addEventListener('scroll', ()=>{
      if (heroTrackScrollLock) return;
      const slides = Array.from(heroTrack.children);
      let bestIdx = 0, bestDist = Infinity;
      const viewportCenter = heroTrack.getBoundingClientRect().left + heroTrack.clientWidth / 2;
      slides.forEach((el,i)=>{
        const rect = el.getBoundingClientRect();
        const slideCenter = rect.left + rect.width/2;
        const dist = Math.abs(slideCenter - viewportCenter);
        if (dist < bestDist){ bestDist = dist; bestIdx = i; }
      });
      if (bestIdx !== cycleIdx){ cycleIdx = bestIdx % Math.max(1, filteredItems.length); setHeroMetaFromIndex(cycleIdx); }
    }, { passive:true });

    $('#prevTopBtn').addEventListener('click', prevHero);
    $('#nextTopBtn').addEventListener('click', nextHero);

    // Header immersive behavior
    let heroIsVisible = true;
    const heroObserver = new IntersectionObserver((entries)=>{ heroIsVisible = entries[0]?.isIntersecting ?? true }, { root:null, threshold:0.2 });
    heroObserver.observe(document.getElementById('heroCard'));
    const startCycle = ()=>{
      stopCycle();
      cycleTimer = setInterval(()=>{
        if (!heroIsVisible) return;
        heroTrackScrollLock = true; nextHero(); setTimeout(()=>{ heroTrackScrollLock = false }, 400);
      }, 12000);
    };
    const stopCycle = ()=>{ if(cycleTimer) clearInterval(cycleTimer); cycleTimer = null; };

    const updateImmersiveHeader = ()=>{
      const threshold = 24;
      if (window.scrollY <= threshold) document.body.classList.add('hero-immersive');
      else document.body.classList.remove('hero-immersive');
    };
    window.addEventListener('scroll', updateImmersiveHeader, { passive:true });

    const heroInViewObserver = new IntersectionObserver((entries)=>{
      const inView = entries[0]?.isIntersecting ?? true;
      document.body.classList.toggle('hero-in-view', inView);
    }, { root:null, threshold:0.6 });
    heroInViewObserver.observe(document.getElementById('heroCard'));

    const waitForHeroImages = (timeoutMs = 6000)=> new Promise(resolve=>{
      const imgs = Array.from(heroTrack.querySelectorAll('img')).slice(0, 3);
      if (!imgs.length) return resolve();
      let done = 0, finished = false;
      const finish = ()=>{ if(!finished){ finished = true; resolve(); } };
      const onOne = ()=>{ done++; if (done >= imgs.length) finish(); };
      imgs.forEach(im=>{
        if (im.complete) onOne();
        else {
          im.addEventListener('load', onOne, { once:true });
          im.addEventListener('error', onOne, { once:true });
          try{ im.decode?.().then(onOne).catch(()=>{}); }catch{}
        }
      });
      setTimeout(finish, timeoutMs);
    });

    // Preloader cycling text
    function preloadCycle(){
      const line = document.getElementById('preloadLine');
      const phrases = [
        'ONX-News',
        'Open Source News.  Without Limits.',
        'The AI Workspace For Pros.'
      ];
      let ix = 0;
      const tick = ()=>{
        line.classList.remove('animate-fade-in');
        line.classList.add('animate-fade-out');
        setTimeout(()=>{
          ix = (ix + 1) % phrases.length;
          line.textContent = phrases[ix];
          line.classList.remove('animate-fade-out');
          line.classList.add('animate-fade-in');
        }, 240);
      };
      line.classList.add('animate-fade-in');
      return setInterval(tick, 2100);
    }

    const hydrate = async ()=>{
      updatedAt.textContent = 'Updating…';
      const items = await loadFeeds(currentEdition);
      cacheItems = items.length ? items : [ { title: 'ONX-News is live — your Apple-grade breaking news surface.', link: '#', pubDate: new Date(), source: 'ONX', image: '' } ];
      cycleIdx = 0;
      applyFilter();
      if (CYCLE_TOPS && filteredItems.length > 3) startCycle(); else stopCycle();
    };

    const hidePreloader = ()=>{
      const pre = document.getElementById('preload');
      if (pre) pre.style.display = 'none';
      document.body.classList.remove('preloading');
    };

    const boot = async ()=>{
      let cycleTimerId;
      try{
        currentEdition = DEFAULT_EDITION;
        setMobileEditionUI();

        setupLazyObserver();

        cycleTimerId = preloadCycle();
        await hydrate();
        await Promise.race([waitForHeroImages(6000), new Promise(res=> setTimeout(res, 800))]);
      }catch(e){ console.error(e); }
      finally{
        if (cycleTimerId) clearInterval(cycleTimerId);
        hidePreloader();
        updateImmersiveHeader();
      }
    };

    const refreshAll = async ()=>{
      try{
        await hydrate();
      }catch(e){ console.error(e); hidePreloader(); }
    };

    // Controls
    $$('.seg-btn').forEach(b=> b.dataset.ed && b.addEventListener('click', ()=>{ currentEdition = b.dataset.ed; setMobileEditionUI(); refreshAll(); }));
    themeBtn?.addEventListener('click', cycleTheme);

    // Image fallbacks — never swap big areas for logos; use Apple "No Image Found"
    const handleImgError = (img)=>{
      const kind = img.dataset.kind || 'badge';
      if (kind !== 'content'){
        // For tiny host badges: try alt1 favicon, then letter tile
        const alt1 = img.dataset.alt1;
        const host = img.dataset.host || '';
        if (alt1 && img.src !== alt1){ img.src = alt1; img.dataset.alt1=''; return; }
        const parent = img.parentElement;
        if (parent){ img.insertAdjacentHTML('afterend', letterTileHTML((host || 'SRC'), img.className)); img.remove(); }
        return;
      }
      // Content images (hero/tiles/trending): replace with clean placeholder
      img.insertAdjacentHTML('afterend', noImageHTML(img.className));
      img.remove();
    };
    document.addEventListener('error', (e)=>{
      const t = e.target;
      if (t && t.tagName==='IMG' && t.classList.contains('brand-fb')) handleImgError(t);
    }, true);

    // Page routing: News / Weather
    function showNews(){
      newsMain.classList.remove('hidden');
      weatherMain.classList.add('hidden');
      newsTab?.classList.add('active');
      document.body.classList.add('hero-immersive');
      window.scrollTo({ top:0, behavior:'instant' });
    }
    async function showWeather(){
      newsMain.classList.add('hidden');
      weatherMain.classList.remove('hidden');
      newsTab?.classList.remove('active');
      document.body.classList.remove('hero-immersive');
      const last = getWx();
      if (last?.lat && last?.lon){ ensureWeatherFor(last); }
      else{
        try{
          const pos = await resolveMyLocation();
          await ensureWeatherFor({ name:'My Location', lat: pos.lat, lon: pos.lon });
        }catch{
          await ensureWeatherFor({ name:'Vancouver, CA', lat:49.2827, lon:-123.1207 });
        }
      }
      window.scrollTo({ top:0, behavior:'instant' });
    }
    weatherBtn?.addEventListener('click', showWeather);
    weatherBtnMobile?.addEventListener('click', showWeather);
    newsTab?.addEventListener('click', showNews);
    weatherTab?.addEventListener('click', showWeather);

    // Start
    const updateHeaderAndBoot = ()=>{ setHeaderVar(); updateImmersiveHeader(); boot(); };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', updateHeaderAndBoot);
    else updateHeaderAndBoot();

    // Theme init + auto follow
    const THEME_INIT = localStorage.getItem('oc_theme') || 'auto';
    setTheme(THEME_INIT);
    window.matchMedia && window.matchMedia('(prefers-color-scheme: light)')
      .addEventListener('change', ()=>{ if ((localStorage.getItem('oc_theme') || 'auto') === 'auto') setTheme('auto') });

    /* ====== SIMPLE WEATHER INPUT HANDLERS ====== */
    wxQuery?.addEventListener('keydown', async (e)=>{
      if (e.key === 'Enter'){
        const q = wxQuery.value.trim();
        if (!q) return;
        try{
          const g = await geocode(q);
          await ensureWeatherFor(g);
        }catch{ wxMeta.textContent = 'Location not found.'; }
      }
    });
    wxMyLocation?.addEventListener('click', async ()=>{
      try{
        const pos = await resolveMyLocation();
        await ensureWeatherFor({ name:'My Location', lat: pos.lat, lon: pos.lon });
      }catch{ wxMeta.textContent = 'Location unavailable.'; }
    });
  </script>
</body>
</html>
