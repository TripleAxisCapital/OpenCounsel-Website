<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="auto">
<head>
  <!--
    OCâ€‘News â€” Appleâ€‘clean, pure white/black. No gradients.
    Singleâ€‘file, dropâ€‘in page. No build, no API keys.

    This build focuses on:
    â€¢ FIX: Google Trends section â€” robust proxy parsing, cleaner Appleâ€‘style cards, image fallbacks.
    â€¢ FIX: Hero doubleâ€‘title â€” overlay title only while hero is onscreen (separate H1 hides); H1 returns after you scroll past.
    â€¢ FIX: Hero image quality â€” prefer real article images (OG/Twitter/LD+JSON), upsize common width params, preload first slides.
    â€¢ Appleâ€‘style loader â€” OCâ€‘News / Your Open Source News / tagline with shine; all waiting held here; global failsafe (20s).
    â€¢ UI simplification â€” removes â€œðŸ”¥ X srcâ€ badges on all cards; Trending rail simplified.
    â€¢ Keeps: editions, search, saved, share, theme, keyboard shortcuts, trending rail logic (still uses duplicates for ranking).
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>OCâ€‘News â€” The AI Workspace. Without Limits.</title>
  <meta name="description" content="OCâ€‘News surfaces the most breaking headlines with an Appleâ€‘style minimal hero. Private, fast, and elegant." />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" href="logo.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','SF Pro Text','Segoe UI','Roboto','Apple Color Emoji','Helvetica Neue','Arial','Noto Color Emoji','sans-serif'] },
          boxShadow: { 'oc-soft': '0 8px 24px -10px rgba(0,0,0,0.35)' },
          keyframes: {
            'pulse-soft': { '0%,100%': { opacity: .65 }, '50%': { opacity: 1 } },
            'ticker': { '0%': { transform: 'translateX(0)' }, '100%': { transform: 'translateX(-50%)' } },
            'progress': { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
            'shine': { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } }
          },
          animation: {
            'pulse-soft': 'pulse-soft 3.6s ease-in-out infinite',
            'ticker': 'ticker 18s linear infinite',
            'progress': 'progress 1.1s ease-in-out infinite',
            'shine': 'shine 1.8s ease-in-out infinite'
          }
        }
      }
    }
  </script>
  <style>
    /* ==========
       THEME TOKENS
       ========== */
    :root{
      --logo-size:34px;--logo-size-lg:40px;
      --radius:14px;
      --bg:#0b0b0c;--surface:#000000;--elev:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.12);
      --text:#f5f7fb;--sub:#a6acb8;--accent:#356dff;--live:#ff3b30;
      --chip:rgba(255,255,255,0.06);--chip-border:rgba(255,255,255,0.12);
      --card-hover:rgba(255,255,255,0.06);
      --header-h:64px;
      --preload-bg-dark:#000; --preload-bg-light:#fff; --preload-text-dark:#fff; --preload-text-light:#000;
    }
    html.light{
      --bg:#ffffff;--surface:#ffffff;--elev:rgba(10,10,15,0.035);
      --border:rgba(5,13,38,0.10);
      --text:#0b0b0e;--sub:#5a6274;--accent:#356dff;--live:#e5484d;
      --chip:rgba(0,0,0,0.035);--chip-border:rgba(0,0,0,0.08);
      --card-hover:rgba(0,0,0,0.045);
    }

    .text-balance{ text-wrap:balance }
    .no-scrollbar::-webkit-scrollbar{ display:none }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    @media (prefers-reduced-motion: reduce){
      .animate-pulse-soft,.animate-ticker,.animate-progress,.animate-shine{ animation:none!important }
      .hero-track{ scroll-behavior:auto!important }
    }

    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius) }
    .chip{ background:var(--chip); border:1px solid var(--chip-border) }
    .btn{ background:transparent; border:1px solid var(--border) }
    .btn:hover{ background:var(--card-hover) }
    .hairline{ height:1px; background:var(--border) }

    .link-btn{ border:0; background:transparent; padding:6px 8px; font-size:.875rem; color:var(--sub); display:inline-flex; align-items:center; gap:8px; border-radius:8px }
    .link-btn:hover{ color:var(--text) }
    .link-btn:focus-visible{ outline:2px solid color-mix(in oklab, var(--accent) 40%, transparent); outline-offset:2px; border-radius:10px }

    .logo-img{ height:var(--logo-size); width:auto; transition:filter .2s ease }
    @media (min-width:640px){ .logo-img{ height:var(--logo-size-lg) } }
    .dark .logo-img{ filter:invert(1) brightness(1.08) }

    /* Apple-style fullscreen preloader */
    #preload{ position:fixed; inset:0; z-index:70; display:grid; place-items:center; background:var(--preload-bg-dark) }
    html.light #preload{ background:var(--preload-bg-light) }
    body.preloading{ overflow:hidden }
    .preload-wrap{ display:grid; gap:10px; place-items:center; text-align:center; padding:24px }
    .preload-mark{ font-weight:800; letter-spacing:-0.02em; font-size:clamp(28px,6.2vw,64px); color:var(--preload-text-dark) }
    html.light .preload-mark{ color:var(--preload-text-light) }
    .preload-mark .shine{ background:linear-gradient(90deg, transparent, rgba(255,255,255,.75), transparent); -webkit-background-clip:text; background-clip:text; color:transparent; background-size:200% 100% }
    html.light .preload-mark .shine{ background:linear-gradient(90deg, transparent, rgba(0,0,0,.45), transparent) }
    .preload-tag, .preload-sub{ color:color-mix(in oklab, var(--preload-text-dark) 60%, transparent); font-size:clamp(12px,2.8vw,14px) }
    html.light .preload-tag, html.light .preload-sub{ color:color-mix(in oklab, var(--preload-text-light) 70%, transparent) }
    .preload-bar{ width:min(380px,72vw); height:3px; border-radius:999px; overflow:hidden; background:color-mix(in oklab, var(--preload-text-dark) 15%, transparent); margin-top:10px }
    html.light .preload-bar{ background:color-mix(in oklab, var(--preload-text-light) 15%, transparent) }
    .preload-bar > span{ display:block; width:40%; height:100%; background:var(--accent) }

    .seg{ display:inline-flex; border:1px solid var(--border); border-radius:999px; padding:2px; background:var(--surface) }
    .seg button{ padding:6px 10px; border-radius:999px; font-size:12px }
    .seg button.active{ background:var(--card-hover) }

    /* ===== FULLâ€‘SCREEN HERO ===== */
    .hero-section-container{ padding-block:1.5rem }
    @media (min-width:640px){ .hero-section-container{ padding-block:2rem } }
    @media (min-width:1024px){ .hero-section-container{ padding-block:2.5rem } }

    #heroCard{ min-height:calc(100svh - var(--header-h)); display:flex; flex-direction:column; overflow:hidden }
    .hero-media{ position:relative; border-radius:calc(var(--radius) - 2px); overflow:hidden; border:1px solid var(--border); flex:1; min-height:0 }
    .hero-track{ display:flex; height:100%; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; scroll-behavior:smooth }
    .hero-slide{ position:relative; flex:0 0 100%; width:100%; height:100%; scroll-snap-align:center }
    .hero-slide a{ position:absolute; inset:0; display:block }
    .hero-slide img{ width:100%; height:100%; object-fit:cover; display:block }
    .hero-gradient{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.00) 40%, rgba(0,0,0,.55) 90%); pointer-events:none }
    html.light .hero-gradient{ background:linear-gradient(180deg, rgba(255,255,255,0.00) 40%, rgba(255,255,255,.65) 90%) }
    .hero-overlay-text{ position:absolute; inset-inline:16px; bottom:16px; display:grid; gap:6px; pointer-events:none }
    .hero-overlay-text h2{ font-size:clamp(20px, 3.5vw, 42px); line-height:1.08; font-weight:800; text-shadow:0 2px 14px rgba(0,0,0,.35) }
    html.light .hero-overlay-text h2{ text-shadow:0 2px 12px rgba(255,255,255,.55) }
    .hero-nav{ position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; pointer-events:none; padding:8px }
    .hero-nav button{ pointer-events:auto; border:1px solid var(--border); background:rgba(0,0,0,.28); backdrop-filter:blur(6px); color:#fff; width:40px; height:40px; border-radius:999px; display:grid; place-items:center }
    html.light .hero-nav button{ background:rgba(255,255,255,.65); color:#000 }
    .hero-dots{ position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:6px }
    .hero-dots span{ width:6px; height:6px; border-radius:999px; background:rgba(255,255,255,.55) }
    .hero-dots span.active{ background:#fff }
    html.light .hero-dots span{ background:rgba(0,0,0,.35) }
    html.light .hero-dots span.active{ background:#000 }

    /* ===== Mobile immersive hero ===== */
    @media (max-width: 639.98px){
      .hero-section-container{ padding:0!important }
      #heroCard{ padding:0!important; border:none!important; border-radius:0!important; box-shadow:none!important; min-height:calc(100svh - var(--header-h)) }
      .hero-media{ border:none!important; border-radius:0!important; height:calc(100svh - var(--header-h)); min-height:calc(100svh - var(--header-h)) }
      .hero-top-meta, #heroTitle, #heroDesc, #sourceBadge, .hero-nav, #heroLink, #shareBtn, #saveBtn, #updatedAt, #tickerWrap{ display:none!important }
      .hero-overlay-text{ inset-inline:16px; bottom:24px }
      .hero-overlay-text > :not(h2){ display:none!important }
      .hero-overlay-text h2{ font-size:clamp(20px, 7vw, 28px); font-weight:800 }
      .hero-dots{ bottom:14px }
    }

    /* Header hiding to avoid top black band */
    body.hero-immersive header{ position:fixed!important; top:0; left:0; right:0; transform:translateY(-100%); opacity:0; pointer-events:none }
    header{ position:sticky; top:0; z-index:40; background:var(--surface); transition:transform .28s ease, opacity .28s ease }
    body.hero-immersive #heroCard{ min-height:100dvh }
    body.hero-immersive .hero-media{ height:100dvh; min-height:100dvh }

    /* Hide separate H1 while hero is visible to prevent double titles */
    body.hero-in-view #heroTitle{ display:none!important }

    /* ===== Trending rail ===== */
    .rail{ display:flex; gap:12px; overflow:auto; scroll-snap-type:x mandatory; padding-block:4px }
    .rail > article{ scroll-snap-align:center; flex:0 0 84%; max-width:84% }
    @media (min-width:640px){ .rail > article{ flex:0 0 420px; max-width:420px } }
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)] antialiased selection:bg-[var(--accent)]/20 selection:text-[var(--text)] preloading hero-immersive">
  <!-- Fullscreen Apple-style Preloader (all waiting held here) -->
  <div id="preload" aria-live="polite" aria-busy="true">
    <div class="preload-wrap">
      <div class="preload-mark">
        <span class="shine inline-block animate-shine">OCâ€‘News</span>
      </div>
      <div class="preload-tag">Your Open Source News.</div>
      <div class="preload-sub">The AI Workspace. Without Limits.</div>
      <div class="preload-bar"><span class="animate-progress"></span></div>
    </div>
  </div>

  <!-- Optional top micro loader (kept for feature parity, unused during preloader) -->
  <div id="topLoader" class="fixed inset-x-0 top-0 h-[2px] overflow-hidden z-[60] hidden">
    <div class="h-full w-1/3 bg-[var(--accent)] animate-progress"></div>
  </div>

  <!-- Header -->
  <header>
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <a href="index.html" class="shrink-0" aria-label="OpenCounsel Home">
            <img src="logo.svg" alt="OpenCounsel" class="logo-img" />
          </a>
          <div class="hidden sm:block text-sm text-[var(--sub)] truncate">The AI Workspace. Without Limits.</div>
        </div>
        <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center gap-2">
            <span class="hidden md:inline text-sm text-[var(--sub)]">Edition:</span>
            <select id="editionSelect" class="btn text-sm rounded-lg px-2.5 py-1.5 outline-none focus:ring-2 focus:ring-[var(--accent)]/30 bg-transparent">
              <option value="CA">Canada</option>
              <option value="US">United States</option>
              <option value="GLOBAL">Global Mix</option>
              <option value="FIN">Financial</option>
            </select>
          </div>
          <div class="relative hidden sm:block">
            <input id="searchInput" placeholder="Search headlinesâ€¦ ( / )" class="w-56 md:w-64 btn rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-[var(--accent)]/30 bg-transparent" />
            <kbd class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-[var(--sub)]">/</kbd>
          </div>
          <!-- Text-only actions -->
          <button id="refreshBtn" class="link-btn" title="Refresh (R)">
            <!-- Circular arrow -->
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 12a9 9 0 1 1-3.22-6.86"/>
              <path d="M21 3v7h-7"/>
            </svg>
            <span class="hidden sm:inline">Refresh</span>
          </button>
          <button id="themeBtn" class="link-btn" title="Toggle theme (T)">
            <span id="themeIcon" class="inline-flex items-center">
              <svg id="sun" class="size-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4" /><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
              <svg id="moon" class="size-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
            </span>
            <span class="hidden sm:inline">Theme</span>
          </button>
        </div>
      </div>
    </div>
    <div class="hairline"></div>
    <!-- Mobile Filters -->
    <div class="sm:hidden">
      <div class="mx-auto max-w-7xl px-4 py-2 flex items-center justify-between gap-2">
        <div class="seg">
          <button class="seg-btn" data-ed="GLOBAL">Global</button>
          <button class="seg-btn" data-ed="US">US</button>
          <button class="seg-btn" data-ed="CA">Canada</button>
          <button class="seg-btn" data-ed="FIN">Financial</button>
        </div>
        <div class="flex-1"></div>
      </div>
      <div class="mx-auto max-w-7xl px-4 pb-2">
        <input id="searchInputMobile" placeholder="Search headlinesâ€¦ ( / )" class="w-full btn rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-[var(--accent)]/30 bg-transparent" />
      </div>
      <div class="hairline"></div>
    </div>
  </header>

  <!-- HERO -->
  <section class="relative">
    <div class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 hero-section-container">
      <div id="heroCard" class="card shadow-oc-soft p-3 sm:p-5 lg:p-7 relative overflow-hidden">
        <div class="flex flex-wrap items-center gap-3 mb-3 sm:mb-4 hero-top-meta">
          <span class="inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-xs font-semibold bg-[var(--live)]/12 text-[var(--text)] border border-[var(--live)]/30">
            <span class="relative inline-block size-2 rounded-full bg-[var(--live)]">
              <span class="absolute inset-0 rounded-full bg-[var(--live)]/60 animate-pulse-soft"></span>
            </span>
            LIVE
          </span>
          <span class="text-xs text-[var(--sub)]" id="heroMeta">Loading top storyâ€¦</span>
          <span class="text-[10px] text-[var(--sub)] chip rounded px-2 py-1" id="sourceBadge">â€”</span>
        </div>

        <figure id="heroMedia" class="hero-media mb-4 bg-[var(--surface)]">
          <div id="heroTrack" class="hero-track no-scrollbar"><!-- Slides injected --></div>
          <div class="hero-nav">
            <button id="prevTopBtn" aria-label="Previous top">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button id="nextTopBtn" aria-label="Next top">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M9 6l6 6-6 6"/></svg>
            </button>
          </div>
          <div id="heroDots" class="hero-dots"></div>
          <div class="hero-gradient"></div>
          <div class="hero-overlay-text">
            <div class="text-xs font-medium text-white/80 dark:text-white/80 overlay-meta-line">Top story</div>
            <h2 id="heroOverlayTitle">â€”</h2>
          </div>
        </figure>

        <!-- Desktop meta (hidden while hero in view to avoid double title) -->
        <h1 id="heroTitle" class="text-balance text-2xl sm:text-3xl lg:text-5xl font-extrabold leading-tight tracking-tight">OCâ€‘News is waking upâ€¦</h1>
        <p id="heroDesc" class="mt-2 sm:mt-3 text-sm sm:text-base lg:text-lg text-[var(--sub)] max-w-3xl">Surfacing the #1 breaking headline across trusted sources. Crisp. Fast. Private.</p>
        <div class="mt-4 sm:mt-6 flex flex-wrap items-center gap-3">
          <a id="heroLink" href="#" target="_blank" rel="noopener" class="btn rounded-lg px-4 py-2 text-sm font-medium focus:ring-2 focus:ring-[var(--accent)]/30">Open Story</a>
          <button id="shareBtn" class="btn rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--accent)]/30">Share</button>
          <button id="saveBtn" class="btn rounded-lg px-3 py-2 text-sm" title="Save for later">Save</button>
          <span id="updatedAt" class="text-xs text-[var(--sub)]">â€”</span>
        </div>
        <div id="tickerWrap" class="mt-6 sm:mt-7 overflow-hidden">
          <div id="ticker" class="flex gap-2 min-w-[200%] whitespace-nowrap animate-ticker will-change-transform"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- TRENDING (Most Read proxy = duplicates across feeds) -->
  <section id="trendingSection" class="relative">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-4 pb-6 sm:py-8">
      <div class="flex items-center justify-between gap-3 mb-3">
        <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Trending â€” Most Read</h2>
        <div class="text-xs text-[var(--sub)]" id="trendHint">Based on # of sources + recency</div>
      </div>
      <div id="trendingRail" class="rail no-scrollbar"><!-- trending cards injected --></div>
    </div>
    <div class="hairline"></div>
  </section>

  <!-- MAIN LIST -->
  <main class="relative">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pb-12">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Breaking Headlines</h2>
        <div class="flex items-center gap-2">
          <label for="sortSelect" class="text-xs text-[var(--sub)] hidden sm:block">Sort:</label>
          <select id="sortSelect" class="btn rounded-lg px-2.5 py-1.5 text-xs outline-none focus:ring-2 focus:ring-[var(--accent)]/30 bg-transparent">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="source">Source Aâ†’Z</option>
          </select>
          <button id="showSavedBtn" class="btn rounded px-2.5 py-1.5 text-xs">Saved</button>
          <div class="text-xs text-[var(--sub)]" id="countLabel">0 stories</div>
        </div>
      </div>
      <ul id="newsList" class="grid gap-3 sm:gap-4"><!-- Populated by JS --></ul>
      <div class="mt-10 text-center text-xs text-[var(--sub)]">
        Sources auto-selected from Google News, BBC, Reuters, CNN, AP, The Guardian, CBC, CTV, Al Jazeera, WSJ, CNBC, FT, MarketWatch, Yahoo Finance, Nasdaq, Investing.com, Seeking Alpha, and more (via CORS-friendly proxies). Times are local.
      </div>
    </div>
  </main>

  <!-- GOOGLE TRENDS TODAY -->
  <section id="gtSection" class="relative">
    <div class="hairline"></div>
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Todayâ€™s Google Trends</h2>
        <div class="text-xs text-[var(--sub)]" id="gtMeta">â€”</div>
      </div>
      <div id="gtGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        <!-- trend cards injected -->
      </div>
      <div id="gtEmpty" class="hidden text-xs text-[var(--sub)] mt-2">Couldnâ€™t fetch Google Trends right now. Try Refresh.</div>
    </div>
  </section>

  <script>
    /* =========================
       CONFIG
       ========================= */
    const DEFAULT_EDITION = 'CA'; // 'CA' | 'US' | 'GLOBAL' | 'FIN'
    const MAX_ITEMS = 64;
    const CYCLE_TOPS = true;
    const SHOW_IMAGES = true;
    const HERO_SLIDES = 10;
    const DOT_COUNT = 6;

    // Loader controls
    const PRELOAD_ON_REFRESH = true; // show Apple loader on refresh too
    const LOADER_MAX_WAIT_MS = 20000; // global failsafe (20s)

    const SORT_MODES = { NEWEST:'newest', OLDEST:'oldest', SOURCE:'source' };
    let sortMode = SORT_MODES.NEWEST;

    // Expanded feeds
    const FEEDS = {
      CA: [
        'https://news.google.com/rss?hl=en-CA&gl=CA&ceid=CA:en',
        'https://feeds.bbci.co.uk/news/rss.xml',
        'https://feeds.reuters.com/reuters/topNews',
        'https://feeds.reuters.com/reuters/worldNews',
        'https://rss.cnn.com/rss/cnn_topstories.rss',
        'https://www.theguardian.com/world/rss',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://apnews.com/hub/ap-top-news?utm_source=ap_rss&utm_medium=rss&utm_campaign=ap_top_news',
        'https://www.cbc.ca/cmlink/rss-topstories',
        'https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.822009',
        'https://globalnews.ca/feed/',
        'https://www.nationalpost.com/feed/',
        // business/markets
        'https://feeds.reuters.com/reuters/businessNews',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        'https://www.ft.com/world?format=rss',
        'https://www.wsj.com/xml/rss/3_7085.xml',
        'https://www.theglobeandmail.com/arc/outboundfeeds/rss/?outputType=xml',
        'https://financialpost.com/feed/'
      ],
      US: [
        'https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en',
        'https://feeds.bbci.co.uk/news/rss.xml',
        'https://feeds.reuters.com/reuters/topNews',
        'https://rss.cnn.com/rss/cnn_topstories.rss',
        'https://www.theguardian.com/us-news/rss',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://apnews.com/hub/ap-top-news?utm_source=ap_rss&utm_medium=rss&utm_campaign=ap_top_news',
        'https://www.npr.org/rss/rss.php?id=1001',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        'https://www.wsj.com/xml/rss/3_7085.xml',
        'https://feeds.reuters.com/reuters/businessNews',
        'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
        'https://feeds.marketwatch.com/marketwatch/topstories/',
        'https://markets.businessinsider.com/rss/news',
        'https://www.usatoday.com/rss/news/'
      ],
      GLOBAL: [
        'https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en',
        'https://feeds.bbci.co.uk/news/rss.xml',
        'https://feeds.reuters.com/reuters/topNews',
        'https://feeds.reuters.com/reuters/worldNews',
        'https://rss.cnn.com/rss/cnn_topstories.rss',
        'https://www.theguardian.com/world/rss',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://apnews.com/hub/ap-top-news?utm_source=ap_rss&utm_medium=rss&utm_campaign=ap_top_news',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        'https://www.wsj.com/xml/rss/3_7085.xml'
      ],
      FIN: [
        'https://feeds.reuters.com/reuters/businessNews',
        'https://www.ft.com/markets?format=rss',
        'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
        'https://feeds.marketwatch.com/marketwatch/topstories/',
        'https://www.cnbc.com/id/10001147/device/rss/rss.html',
        'https://www.theguardian.com/business/markets/rss',
        'http://finance.yahoo.com/rss/topstories',
        'https://finance.yahoo.com/news/rssindex',
        'https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=en-US&gl=US&ceid=US:en',
        'https://news.google.com/rss/search?q=stock%20market%20OR%20stocks%20OR%20%22S%26P%20500%22&hl=en-US&gl=US&ceid=US:en',
        'https://www.nasdaq.com/feed/rssoutbound?category=Markets',
        'https://www.nasdaq.com/feed/rssoutbound?category=Investing',
        'https://www.investing.com/rss/news.rss',
        'https://www.investing.com/rss/news_285.rss',
        'https://www.investing.com/rss/news_25.rss',
        'https://feeds.bloomberg.com/markets/news.rss',
        'https://www.economist.com/finance-and-economics/rss.xml',
        'https://seekingalpha.com/feed.xml',
        'https://news.google.com/rss/search?q=site%3Afinance.yahoo.com&hl=en-US&gl=US&ceid=US:en'
      ]
    };

    const proxyCandidates = (url) => ([
      `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      `https://r.jina.ai/http/${url.replace(/^https?:\/\//,'')}`
    ]);

    const BRAND_HINTS = {
      'news.google.com':'https://logo.clearbit.com/google.com',
      'bbc.co.uk':'https://logo.clearbit.com/bbc.co.uk',
      'bbc.com':'https://logo.clearbit.com/bbc.com',
      'reuters.com':'https://logo.clearbit.com/reuters.com',
      'cnn.com':'https://logo.clearbit.com/cnn.com',
      'theguardian.com':'https://logo.clearbit.com/theguardian.com',
      'aljazeera.com':'https://logo.clearbit.com/aljazeera.com',
      'apnews.com':'https://logo.clearbit.com/apnews.com',
      'cbc.ca':'https://logo.clearbit.com/cbc.ca',
      'ctvnews.ca':'https://logo.clearbit.com/ctvnews.ca',
      'globalnews.ca':'https://logo.clearbit.com/globalnews.ca',
      'nationalpost.com':'https://logo.clearbit.com/nationalpost.com',
      'cnbc.com':'https://logo.clearbit.com/cnbc.com',
      'ft.com':'https://logo.clearbit.com/ft.com',
      'wsj.com':'https://logo.clearbit.com/wsj.com',
      'npr.org':'https://logo.clearbit.com/npr.org',
      'theglobeandmail.com':'https://logo.clearbit.com/theglobeandmail.com',
      'marketwatch.com':'https://logo.clearbit.com/marketwatch.com',
      'finance.yahoo.com':'https://logo.clearbit.com/yahoo.com',
      'nasdaq.com':'https://logo.clearbit.com/nasdaq.com',
      'investing.com':'https://logo.clearbit.com/investing.com',
      'bloomberg.com':'https://logo.clearbit.com/bloomberg.com',
      'economist.com':'https://logo.clearbit.com/economist.com',
      'seekingalpha.com':'https://logo.clearbit.com/seekingalpha.com',
      'businessinsider.com':'https://logo.clearbit.com/businessinsider.com',
      'usatoday.com':'https://logo.clearbit.com/usatoday.com'
    };

    /* =========================
       UTILS
       ========================= */
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    const timeAgo = (d)=>{
      const now = new Date();
      const diff = Math.max(0, now - d);
      const sec = Math.floor(diff/1000);
      if (sec<45) return `${sec}s ago`;
      const min = Math.floor(sec/60);
      if (min<60) return `${min}m ago`;
      const hr = Math.floor(min/60);
      if (hr<24) return `${hr}h ago`;
      const day = Math.floor(hr/24);
      return `${day}d ago`;
    };

    const cleanLink = (url)=>{
      try{
        const u = new URL(url);
        const wrapped = u.searchParams.get('url') || u.searchParams.get('u');
        return wrapped ? decodeURIComponent(wrapped) : url;
      }catch{ return url }
    };
    const hostname = (url)=>{ try{ return new URL(url).hostname.replace(/^www\./,'') } catch{ return '' } };
    const absolutize = (src, base)=>{
      try{
        if(!src) return '';
        if (src.startsWith('data:')) return '';
        if (/^https?:\/\//i.test(src)) return src;
        if (src.startsWith('//')) return (new URL(base)).protocol + src;
        return new URL(src, base).toString();
      }catch{ return src }
    };
    const normalizeTitle = (t)=> t.toLowerCase().replace(/[\W_]+/g,' ').trim();
    const pick = (el, sel)=> el.querySelector(sel)?.getAttribute('content')?.trim() || el.querySelector(sel)?.textContent?.trim();
    const getAttr = (el, sel, attr)=> el.querySelector(sel)?.getAttribute(attr);

    const brandSources = (host)=>{
      const base = BRAND_HINTS[host] || `https://logo.clearbit.com/${host}`;
      return {
        src: `${base}?size=512`,
        srcset: `${base}?size=64 64w, ${base}?size=128 128w, ${base}?size=256 256w, ${base}?size=512 512w`,
        s2: `https://www.google.com/s2/favicons?domain=${host}&sz=256`
      };
    };
    const brandLogoHTML = (host, className = '', alt = '')=>{
      const b = brandSources(host);
      return `<img src="${b.src}" srcset="${b.srcset}" sizes="(max-width:640px) 50vw, 33vw" data-alt1="${b.s2}" data-host="${host}" alt="${alt || host}" class="${className} brand-fb">`;
    };
    const letterTileHTML = (label='?', className='')=>`
      <div class="w-full h-full grid place-items-center bg-[var(--surface)] ${className}">
        <span class="text-xs sm:text-sm font-semibold" style="color: var(--sub)">${label.slice(0,3).toUpperCase()}</span>
      </div>
    `;

    // Attempt to bump typical width params to hiâ€‘res
    const upscaleImageUrl = (u)=>{
      try{
        let url = new URL(u);
        const keys = ['w','width','maxwidth','px','param','imgw'];
        keys.forEach(k=>{ if (url.searchParams.has(k)) url.searchParams.set(k,'1600'); });
        // Reuters / CNN style path param ?w= or /?width=
        return url.toString();
      }catch{
        // query-like patterns in plain strings
        return u.replace(/([?&])(w|width|maxwidth|px)=\d+/gi,'$1$2=1600');
      }
    };

    /* =========================
       RSS + IMAGE RESOLUTION
       ========================= */
    const parseRSS = (text)=>{
      const tryXML = ()=>{
        const dom = new DOMParser().parseFromString(text, 'text/xml');
        return dom.querySelector('parsererror') ? null : dom;
      };
      const dom = tryXML();
      if(!dom){
        const items = [];
        const blocks = text.split(/<\/item>/i);
        for(const b of blocks){
          const t  = (b.match(/<title>([^<]+)<\/title>/i) || ['', '' ])[1];
          const lk = cleanLink((b.match(/<link>([^<]+)<\/link>/i) || ['', '' ])[1]);
          const pd = (b.match(/<pubDate>([^<]+)<\/pubDate>/i) || ['', '' ])[1];
          const sc = (b.match(/<source[^>]*>([^<]+)<\/source>/i) || ['', '' ])[1];
          const img = (b.match(/<media:content[^>]*url="([^"]+)"/i) || b.match(/<enclosure[^>]*url="([^"]+)"/i) || ['', '' ])[1];
          if(t && lk) items.push({title:t, link:lk, pubDate: pd?new Date(pd):new Date(), source: sc||hostname(lk), image: img||''});
        }
        return items;
      }else{
        const items = [];
        dom.querySelectorAll('item').forEach(it=>{
          const title = pick(it,'title') || '';
          let link = pick(it,'link') || '';
          link = cleanLink(link);
          const pub  = pick(it,'pubDate') || '';
          const src  = pick(it,'source') || '';
          const img1 = getAttr(it,'media\\:content','url');
          const img2 = getAttr(it,'enclosure','url');
          items.push({ title, link, pubDate: pub ? new Date(pub) : new Date(), source: src || hostname(link), image: img1 || img2 || '' });
        });
        return items;
      }
    };

    const fetchWithProxies = async (url)=>{
      const candidates = proxyCandidates(url);
      for (const prox of candidates){
        try{
          const res = await fetch(prox, { cache: 'no-store' });
          if(!res.ok) continue;
          const text = await res.text();
          if(text && text.length > 40) return text;
        }catch(_){ }
      }
      throw new Error('All proxies failed for ' + url);
    };

    const IMG_CACHE = new Map();
    const resolving = new Set();

    const tryFindOgImage = (html, baseUrl)=>{
      try{
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const tryMeta = (sel)=> absolutize(pick(doc, sel), baseUrl);
        const cands = [
          'meta[property="og:image:secure_url"]',
          'meta[property="og:image:url"]',
          'meta[property="og:image"]',
          'meta[name="og:image"]',
          'meta[name="twitter:image:src"]',
          'meta[name="twitter:image"]'
        ];
        for(const sel of cands){
          const u = tryMeta(sel); if(u) return u;
        }
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for(const s of scripts){
          try{
            const data = JSON.parse(s.textContent.trim());
            const collect = (obj)=>{
              if(!obj) return null;
              if(typeof obj === 'string') return absolutize(obj, baseUrl);
              if(Array.isArray(obj)){
                for(const it of obj){ const inner = collect(it); if(inner) return inner; }
              }else if(typeof obj === 'object'){
                if(obj.image) return collect(obj.image);
                if(obj.thumbnailUrl) return absolutize(obj.thumbnailUrl, baseUrl);
                if(obj.logo) return collect(obj.logo);
              }
              return null;
            };
            const found = collect(data); if(found) return found;
          }catch{}
        }
        const imgs = Array.from(doc.querySelectorAll('img'));
        for(const im of imgs){
          const src = absolutize(im.getAttribute('src') || im.getAttribute('data-src') || '', baseUrl);
          if(!src) continue;
          const w = parseInt(im.getAttribute('width')||'0',10);
          const h = parseInt(im.getAttribute('height')||'0',10);
          if ((w>=300 || h>=200) || /[\/-](hero|lead|feature|main|large|og|share)[-_.]/i.test(src)) return src;
        }
      }catch{}
      return '';
    };

    const resolveArticleImage = async (url)=>{
      if(!url) return '';
      if(IMG_CACHE.has(url)) return IMG_CACHE.get(url);
      if(resolving.has(url)) return '';
      resolving.add(url);
      try{
        const html = await fetchWithProxies(url);
        const img = tryFindOgImage(html, url) || '';
        const better = img ? upscaleImageUrl(img) : '';
        IMG_CACHE.set(url, better);
        return better;
      }catch{
        IMG_CACHE.set(url, '');
        return '';
      }finally{ resolving.delete(url) }
    };

    const improveImagesFor = async (items, limit=12)=>{
      const targets = items.filter(it=>!it.image).slice(0, limit);
      let updated = false;
      await Promise.all(targets.map(async (it)=>{
        const best = await resolveArticleImage(it.link);
        if(best){ it.image = best; updated = true; }
      }));
      if(updated){ applyFilter(); }
    };

    const loadFeeds = async (editionKey)=>{
      const feeds = FEEDS[editionKey] || FEEDS['GLOBAL'];
      const all = [];
      await Promise.allSettled(
        feeds.map(async (f)=>{
          try{
            const text = await fetchWithProxies(f);
            const items = parseRSS(text);
            all.push(...items);
          }catch(_){ }
        })
      );
      // Deduplicate and trend scoring
      const seen = new Map(); // normTitle -> { item, count }
      for(const it of all){
        const key = normalizeTitle(it.title);
        if(!key) continue;
        const prev = seen.get(key);
        if(!prev){ seen.set(key, { item: it, count: 1 }); }
        else{
          if (it.pubDate && prev.item.pubDate && it.pubDate > prev.item.pubDate) prev.item = it;
          prev.count++;
        }
      }
      let uniq = Array.from(seen.values()).map(({item, count})=> ({...item, trendCount: count}));
      const now = Date.now();
      uniq.forEach(u=>{
        const ageMin = Math.max(1, (now - (u.pubDate?.getTime?.()||now))/60000);
        u._score = (u.trendCount||1) * (1/ageMin);
        if (u.image) u.image = upscaleImageUrl(u.image);
      });
      uniq.sort((a,b)=> (b._score - a._score) || ((b.pubDate||0) - (a.pubDate||0)));
      return uniq.slice(0, MAX_ITEMS);
    };

    // Bookmarks
    const SAVED_KEY = 'oc_news_saved';
    const getSaved = ()=>{ try{ return JSON.parse(localStorage.getItem(SAVED_KEY)||'[]') }catch{ return [] } };
    const setSaved = (arr)=> localStorage.setItem(SAVED_KEY, JSON.stringify(arr.slice(0,200)));
    const isSaved = (link)=> getSaved().some(x=>x.link===link);
    const toggleSave = (item)=>{
      const cur = getSaved();
      const idx = cur.findIndex(x=>x.link===item.link);
      if(idx>=0){ cur.splice(idx,1) } else { cur.unshift({ ...item, savedAt: Date.now() }) }
      setSaved(cur);
    };

    /* =========================
       RENDER
       ========================= */
    const heroTitle = $('#heroTitle');
    const heroDesc  = $('#heroDesc');
    const heroMeta  = $('#heroMeta');
    const heroLink  = $('#heroLink');
    const heroTrack = $('#heroTrack');
    const heroDots  = $('#heroDots');
    const updatedAt = $('#updatedAt');
    const newsList  = $('#newsList');
    const countLabel= $('#countLabel');
    const ticker    = $('#ticker');
    const sourceBadge = $('#sourceBadge');
    const topLoader = $('#topLoader');
    const preload   = $('#preload');
    const heroOverlayTitle = $('#heroOverlayTitle');
    const trendingRail = $('#trendingRail');
    const gtGrid = $('#gtGrid'); const gtMeta = $('#gtMeta'); const gtEmpty = $('#gtEmpty');

    let searchQuery = '';
    let showingSaved = false;
    let currentEdition = DEFAULT_EDITION;
    let cacheItems = [];
    let filteredItems = [];
    let cycleIdx = 0;
    let cycleTimer = null;

    const applySort = ()=>{
      const arr = filteredItems.slice();
      if (sortMode === SORT_MODES.NEWEST) arr.sort((a,b)=>(b.pubDate||0)-(a.pubDate||0));
      else if (sortMode === SORT_MODES.OLDEST) arr.sort((a,b)=>(a.pubDate||0)-(b.pubDate||0));
      else if (sortMode === SORT_MODES.SOURCE) arr.sort((a,b)=>(a.source||hostname(a.link)||'').localeCompare(b.source||hostname(b.link)||''));
      filteredItems = arr;
    };

    const applyFilter = ()=>{
      const needle = searchQuery.toLowerCase().trim();
      const base = showingSaved ? getSaved() : cacheItems;
      if(!needle){ filteredItems = base.slice(); }
      else{
        filteredItems = base.filter(it =>
          it.title?.toLowerCase().includes(needle) ||
          (it.source || '').toLowerCase().includes(needle) ||
          hostname(it.link).toLowerCase().includes(needle)
        );
      }
      applySort();
      render(filteredItems);
    };

    const renderTicker = (items)=>{
      const chips = (items.slice(0, 24).map(it=>{
        const src = it.source || hostname(it.link) || 'Source';
        const safe = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `<span class="chip rounded-full px-2.5 py-1 text-[11px] mr-2">${src}: ${safe}</span>`;
      }).join('')) || '';
      ticker.innerHTML = chips + chips;
    };

    const buildHeroSlides = (items)=>{
      const list = items.slice(0, Math.min(HERO_SLIDES, items.length));
      heroTrack.innerHTML = list.map((it, idx)=>{
        const host = hostname(it.link) || 'news.google.com';
        const src  = (SHOW_IMAGES && it.image) ? upscaleImageUrl(it.image) : '';
        const label= it.source || host;
        const high = idx === 0 ? 'fetchpriority="high" loading="eager"' : 'loading="lazy"';
        const imgHTML = src ? `<img ${high} decoding="async" src="${src}" alt="${label}">` : brandLogoHTML(host, '', label);
        const safeTitle = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
          <div class="hero-slide" data-index="${idx}" data-link="${it.link}">
            <a href="${it.link}" target="_blank" rel="noopener" aria-label="${safeTitle}"></a>
            ${imgHTML}
            <div class="hero-gradient"></div>
            <div class="hero-overlay-text">
              <div class="text-xs font-medium text-white/80 dark:text-white/80">${label} â€¢ ${timeAgo(it.pubDate)}</div>
              <h2>${safeTitle}</h2>
            </div>
          </div>
        `;
      }).join('');
      const dcount = Math.min(DOT_COUNT, Math.max(1, list.length));
      heroDots.innerHTML = Array.from({ length: dcount }).map((_,i)=>`<span class="${i===0?'active':''}"></span>`).join('');
    };

    const setHeroMetaFromIndex = (idx)=>{
      if(!filteredItems.length) return;
      const item = filteredItems[idx % filteredItems.length];
      const host = hostname(item.link);
      heroTitle.textContent = item.title;
      heroOverlayTitle.textContent = item.title;
      heroDesc.textContent  = item.source ? `From ${item.source}` : host;
      heroMeta.textContent  = `${timeAgo(item.pubDate)} â€¢ #1 breaking now`;
      heroLink.href         = item.link;
      sourceBadge.textContent = host;
      heroLink.classList.remove('pointer-events-none','opacity-60');
      const children = Array.from(heroDots.children);
      if (children.length){
        const dotIndex = Math.min(children.length-1, idx % children.length);
        children.forEach((d,i)=>d.classList.toggle('active', i===dotIndex));
      }
    };

    const renderTrending = (items)=>{
      if(!items.length){ trendingRail.innerHTML = ''; return; }
      const top = items.slice().sort((a,b)=> (b.trendCount - a.trendCount) || ((b.pubDate||0)-(a.pubDate||0))).slice(0,12);
      trendingRail.innerHTML = top.map(it=>{
        const host = hostname(it.link);
        const srcHTML = it.image
          ? `<img src="${upscaleImageUrl(it.image)}" class="w-full h-44 object-cover rounded-md border border-[var(--border)] brand-fb" data-host="${host}" alt="">`
          : brandLogoHTML(host,'w-full h-44 object-contain rounded-md border border-[var(--border)]', it.source||host);
        const safeTitle = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
          <article class="card p-3 sm:p-4">
            <a href="${it.link}" target="_blank" rel="noopener" class="block mb-3 rounded-md overflow-hidden">${srcHTML}</a>
            <div class="flex items-center justify-between gap-3 text-[11px] text-[var(--sub)] mb-1">
              <span>${timeAgo(it.pubDate)}</span>
              <span>${it.source || host}</span>
            </div>
            <a href="${it.link}" target="_blank" rel="noopener" class="block">
              <h3 class="text-sm sm:text-base font-semibold leading-snug hover:underline decoration-[var(--accent)]/60 underline-offset-4">${safeTitle}</h3>
            </a>
          </article>
        `;
      }).join('');
    };

    const render = (items)=>{
      if(!items || !items.length){
        heroTitle.textContent = 'No headlines available right now.';
        heroOverlayTitle.textContent = 'No headlines available right now.';
        heroDesc.textContent  = 'Try Refresh â€” or check your connection.';
        heroMeta.textContent  = 'â€”';
        heroLink.classList.add('pointer-events-none','opacity-60');
        sourceBadge.textContent = 'â€”';
        countLabel.textContent = '0 stories';
        newsList.innerHTML = ''; ticker.innerHTML = ''; heroTrack.innerHTML = ''; heroDots.innerHTML = '';
        trendingRail.innerHTML = '';
        return;
      }
      if (cycleIdx >= items.length) cycleIdx = 0;
      buildHeroSlides(items);
      setHeroMetaFromIndex(cycleIdx);
      updatedAt.textContent = `Updated ${new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}`;
      renderTicker(items);
      countLabel.textContent = `${items.length} stor${items.length === 1 ? 'y' : 'ies'}`;

      // Render main list (simplified â€” no fire/src badges)
      newsList.innerHTML = items.map(it=>{
        const src = it.source || hostname(it.link) || 'Source';
        const when = timeAgo(it.pubDate);
        const host = hostname(it.link);
        const saved = isSaved(it.link);
        const safeTitle = it.title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const thumbHTML = (SHOW_IMAGES && it.image)
          ? `<img src="${upscaleImageUrl(it.image)}" alt="" class="w-12 h-12 rounded-lg object-cover border border-[var(--border)] brand-fb" data-host="${host}">`
          : brandLogoHTML(host, 'w-12 h-12 rounded-lg object-contain border border-[var(--border)]', src);
        return `
          <li class="card hover:bg-[var(--card-hover)] p-4 sm:p-5 transition-colors">
            <div class="flex items-start gap-3">
              <a href="${it.link}" target="_blank" rel="noopener" class="shrink-0 w-12 h-12 rounded-lg overflow-hidden">${thumbHTML}</a>
              <div class="min-w-0 flex-1">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-xs font-medium text-[var(--sub)]">${src} â€¢ ${when}</div>
                  <div class="flex items-center gap-1.5">
                    <button data-save='${encodeURIComponent(JSON.stringify(it))}' data-link="${it.link}" class="saveBtn text-[11px] chip rounded px-2 py-1">${saved ? 'Saved' : 'Save'}</button>
                  </div>
                </div>
                <a href="${it.link}" target="_blank" rel="noopener" class="group block">
                  <h3 class="mt-2 text-sm sm:text-base font-semibold leading-snug group-hover:underline decoration-[var(--accent)]/60 underline-offset-4">${safeTitle}</h3>
                </a>
              </div>
            </div>
          </li>
        `;
      }).join('');

      // Bind save buttons
      $$('.saveBtn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const raw = decodeURIComponent(e.currentTarget.getAttribute('data-save')||'%7B%7D');
          try{ toggleSave(JSON.parse(raw)); applyFilter(); }catch{}
        });
      });

      // Render Trending rail
      renderTrending(items);

      // Improve missing images progressively
      improveImagesFor(items.slice(0, HERO_SLIDES), HERO_SLIDES).then(()=>{});
      improveImagesFor(items.slice(HERO_SLIDES), 18);
    };

    /* =========================
       THEME
       ========================= */
    const themeBtn = $('#themeBtn');
    const sunIcon = document.getElementById('sun');
    const moonIcon = document.getElementById('moon');
    const THEME_KEY = 'oc_theme';
    const resolveAutoTheme = ()=> window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    const setTheme = (mode)=>{
      document.documentElement.dataset.theme = mode;
      const final = (mode === 'auto') ? resolveAutoTheme() : mode;
      document.documentElement.classList.toggle('light', final === 'light');
      document.documentElement.classList.toggle('dark',  final === 'dark');
      localStorage.setItem(THEME_KEY, mode);
      sunIcon.classList.toggle('hidden', final !== 'light');
      moonIcon.classList.toggle('hidden', final !== 'dark');
    };
    const cycleTheme = ()=>{
      const cur = localStorage.getItem(THEME_KEY) || 'auto';
      const next = cur === 'auto' ? 'dark' : (cur === 'dark' ? 'light' : 'auto');
      setTheme(next);
    };

    /* =========================
       GOOGLE TRENDS (Daily) â€” robust + Appleâ€‘style
       ========================= */
    const tzMinutes = -new Date().getTimezoneOffset();
    const trendsGeoForEdition = (ed)=>{
      if (ed === 'CA') return 'CA';
      if (ed === 'US' || ed === 'FIN' || ed === 'GLOBAL') return 'US';
      return 'US';
    };
    const fetchGoogleTrendsDaily = async (geo)=>{
      const url = `https://trends.google.com/trends/api/dailytrends?hl=en-US&tz=${tzMinutes}&geo=${geo}`;
      const raw = await fetchWithProxies(url);
      const jsonText = raw.replace(/^\)\]\}',?/, '').trim();
      const data = JSON.parse(jsonText);
      return data;
    };
    const renderGoogleTrends = async ()=>{
      try{
        const data = await fetchGoogleTrendsDaily(trendsGeoForEdition(currentEdition));
        const day = data?.default?.trendingSearchesDays?.[0];
        if(!day || !day.trendingSearches?.length) throw new Error('Empty trends');
        gtMeta.textContent = `${day.date || 'Today'}${day.formattedDate ? ' â€¢ ' + day.formattedDate : ''}`.trim();
        const cards = day.trendingSearches.slice(0, 9).map(ts=>{
          const query = ts.title?.query || 'Trending';
          const traffic = ts.formattedTraffic || '';
          const art = (ts.articles||[])[0] || {};
          const link = art.url || '#';
          const host = hostname(link) || 'google.com';
          const image = (ts.image && ts.image.imageUrl) || (art.image && art.image.imageUrl) || '';
          const img = image ? `<img src="${upscaleImageUrl(image)}" alt="" class="w-full h-40 object-cover rounded-md border border-[var(--border)]">`
                            : brandLogoHTML(host,'w-full h-40 object-contain rounded-md border border-[var(--border)]', query);
          const source = art.source || host || 'Google';
          const title = (art.title || query).replace(/</g,'&lt;').replace(/>/g,'&gt;');
          const trafficTag = traffic ? `<span class="chip rounded px-2 py-1">â†— ${traffic}</span>` : '';
          return `
            <article class="card p-3 sm:p-4">
              <a href="${link}" target="_blank" rel="noopener" class="block mb-3 rounded-md overflow-hidden">${img}</a>
              <div class="flex items-center justify-between gap-3 text-[11px] text-[var(--sub)] mb-1">
                ${trafficTag}
                <span>${source}</span>
              </div>
              <h3 class="text-sm sm:text-base font-semibold leading-snug">${title}</h3>
              <div class="mt-1 text-[11px] text-[var(--sub)]">${query}</div>
            </article>
          `;
        }).join('');
        gtGrid.innerHTML = cards;
        gtEmpty.classList.add('hidden');
      }catch(e){
        gtGrid.innerHTML = '';
        gtMeta.textContent = 'â€”';
        gtEmpty.classList.remove('hidden');
      }
    };

    /* =========================
       BOOTSTRAP + Loader discipline
       ========================= */
    const editionSelect = $('#editionSelect');
    const refreshBtn = $('#refreshBtn');
    const shareBtn = $('#shareBtn');
    const saveBtn  = $('#saveBtn');
    const showSavedBtn = $('#showSavedBtn');
    const searchInput = $('#searchInput');
    const searchInputMobile = $('#searchInputMobile');
    const sortSelect = $('#sortSelect');
    const prevTopBtn = $('#prevTopBtn');
    const nextTopBtn = $('#nextTopBtn');

    const headerEl = document.querySelector('header');
    const setHeaderVar = ()=> document.documentElement.style.setProperty('--header-h', (headerEl?.offsetHeight || 64)+'px');
    setHeaderVar();
    window.addEventListener('resize', setHeaderVar);

    const setMobileEditionUI = ()=> { $$('.seg-btn').forEach(b=> b.classList.toggle('active', b.dataset.ed === currentEdition)); };

    // Hero slide helpers
    const slideTo = (idx)=>{
      const slides = Array.from(heroTrack.children);
      if(!slides.length) return;
      const clamped = Math.max(0, Math.min(slides.length-1, idx));
      const target = slides[clamped];
      if(!target) return;
      heroTrack.scrollTo({ left: target.offsetLeft, behavior: 'smooth' });
      cycleIdx = clamped % Math.max(1, filteredItems.length);
      setHeroMetaFromIndex(cycleIdx);
    };
    const nextHero = ()=> slideTo((cycleIdx + 1) % Math.max(1, filteredItems.length));
    const prevHero = ()=> slideTo((cycleIdx - 1 + Math.max(1, filteredItems.length)) % Math.max(1, filteredItems.length));

    let heroTrackScrollLock = false;
    heroTrack.addEventListener('scroll', ()=>{
      if (heroTrackScrollLock) return;
      const slides = Array.from(heroTrack.children);
      let bestIdx = 0, bestDist = Infinity;
      const viewportCenter = heroTrack.getBoundingClientRect().left + heroTrack.clientWidth / 2;
      slides.forEach((el,i)=>{
        const rect = el.getBoundingClientRect();
        const slideCenter = rect.left + rect.width/2;
        const dist = Math.abs(slideCenter - viewportCenter);
        if (dist < bestDist){ bestDist = dist; bestIdx = i; }
      });
      if (bestIdx !== cycleIdx){ cycleIdx = bestIdx % Math.max(1, filteredItems.length); setHeroMetaFromIndex(cycleIdx); }
    }, { passive:true });

    prevTopBtn.addEventListener('click', prevHero);
    nextTopBtn.addEventListener('click', nextHero);

    // Pause auto-cycle when hero offscreen
    let heroIsVisible = true;
    const heroObserver = new IntersectionObserver((entries)=>{ heroIsVisible = entries[0]?.isIntersecting ?? true }, { root:null, threshold:0.2 });
    heroObserver.observe(document.getElementById('heroCard'));

    const startCycle = ()=>{
      stopCycle();
      cycleTimer = setInterval(()=>{
        if (!heroIsVisible) return;
        if (document.activeElement === searchInput || document.activeElement === searchInputMobile) return;
        heroTrackScrollLock = true; nextHero(); setTimeout(()=>{ heroTrackScrollLock = false }, 400);
      }, 12000);
    };
    const stopCycle = ()=>{ if(cycleTimer) clearInterval(cycleTimer); cycleTimer = null; };

    const updateImmersiveHeader = ()=>{
      const threshold = 12;
      if (window.scrollY <= threshold) document.body.classList.add('hero-immersive');
      else document.body.classList.remove('hero-immersive');
    };
    window.addEventListener('scroll', updateImmersiveHeader, { passive:true });

    // Additional observer to hide H1 while hero is onscreen (prevents double titles)
    const heroInViewObserver = new IntersectionObserver((entries)=>{
      const inView = entries[0]?.isIntersecting ?? true;
      document.body.classList.toggle('hero-in-view', inView);
    }, { root:null, threshold:0.6 });
    heroInViewObserver.observe(document.getElementById('heroCard'));

    // Preload hero images before dropping the loader
    const waitForHeroImages = (timeoutMs = 6000)=> new Promise(resolve=>{
      const imgs = Array.from(heroTrack.querySelectorAll('img')).slice(0, 3); // first few slides
      if (!imgs.length) return resolve();
      let done = 0, finished = false;
      const finish = ()=>{ if(!finished){ finished = true; resolve(); } };
      const onOne = ()=>{ done++; if (done >= imgs.length) finish(); };
      imgs.forEach(im=>{
        if (im.complete) onOne();
        else {
          im.addEventListener('load', onOne, { once:true });
          im.addEventListener('error', onOne, { once:true });
          try{ im.decode?.().then(onOne).catch(()=>{}); }catch{}
        }
      });
      setTimeout(finish, timeoutMs);
    });

    // One hydrate pass: loads feeds and Trends, renders DOM (does not hide preloader)
    const hydrate = async ()=>{
      updatedAt.textContent = 'Updatingâ€¦';
      const items = await loadFeeds(currentEdition);
      cacheItems = items.length ? items : [ { title: 'OCâ€‘News is live â€” your Appleâ€‘grade breaking news surface.', link: '#', pubDate: new Date(), source: 'OC', image: '' } ];
      cycleIdx = 0;
      applyFilter(); // renders (builds hero slides)
      if (CYCLE_TOPS && filteredItems.length > 3) startCycle(); else stopCycle();
      await renderGoogleTrends();
    };

    // Hide the preloader decisively (all waiting is held here)
    const hidePreloader = ()=>{
      if (preload) preload.style.display = 'none';
      document.body.classList.remove('preloading');
    };

    // Full boot: run hydrate, then wait for hero images OR failsafe, then hide loader
    const boot = async ()=>{
      const start = Date.now();
      try{
        await hydrate();
        await Promise.race([
          waitForHeroImages(6000),
          new Promise(res=> setTimeout(res, Math.max(2000, 600))), // ensure a perceptible Apple feel
        ]);
      }catch(e){ console.error(e); }
      finally{
        const elapsed = Date.now() - start;
        const remaining = Math.max(0, LOADER_MAX_WAIT_MS - elapsed);
        // Ensure we never exceed the global failsafe
        setTimeout(hidePreloader, Math.min(remaining, 0));
        hidePreloader();
        updateImmersiveHeader();
      }
    };

    // Refresh flow: optionally use full preloader again
    const refreshAll = async ()=>{
      if (PRELOAD_ON_REFRESH){
        preload.style.display = 'grid';
        document.body.classList.add('preloading');
      }
      try{
        await hydrate();
        if (PRELOAD_ON_REFRESH){
          await Promise.race([waitForHeroImages(4000), new Promise(res=> setTimeout(res, 600))]);
          hidePreloader();
        }
      }catch(e){ console.error(e); hidePreloader(); }
    };

    // Events
    const editionSelectEl = $('#editionSelect');
    if (editionSelectEl) editionSelectEl.value = DEFAULT_EDITION;
    currentEdition = DEFAULT_EDITION;
    setMobileEditionUI();

    editionSelect.addEventListener('change', ()=>{ currentEdition = editionSelect.value; setMobileEditionUI(); refreshAll(); });
    $$('.seg-btn').forEach(b=> b.addEventListener('click', ()=>{ currentEdition = b.dataset.ed; editionSelect.value = currentEdition; setMobileEditionUI(); refreshAll(); }));

    refreshBtn.addEventListener('click', refreshAll);

    shareBtn.addEventListener('click', async ()=>{
      const url = heroLink.href;
      const title = heroTitle.textContent || 'OCâ€‘News';
      try{
        if (navigator.share) await navigator.share({ title, url });
        else { await navigator.clipboard.writeText(url); shareBtn.textContent = 'Copied'; setTimeout(()=> shareBtn.textContent='Share', 1200); }
      }catch{}
    });

    saveBtn.addEventListener('click', ()=>{
      if (!filteredItems.length) return;
      const top = filteredItems[cycleIdx % filteredItems.length];
      toggleSave(top);
      saveBtn.textContent = isSaved(top.link) ? 'Saved' : 'Save';
    });

    showSavedBtn.addEventListener('click', ()=>{ showingSaved = !showingSaved; showSavedBtn.textContent = showingSaved ? 'All' : 'Saved'; applyFilter(); });

    const syncSearch = (val)=>{
      searchQuery = val || '';
      if (searchInput && document.activeElement !== searchInput) searchInput.value = val;
      if (searchInputMobile && document.activeElement !== searchInputMobile) searchInputMobile.value = val;
      applyFilter();
    };
    searchInput && searchInput.addEventListener('input', (e)=> syncSearch(e.target.value));
    searchInputMobile && searchInputMobile.addEventListener('input', (e)=> syncSearch(e.target.value));

    sortSelect.addEventListener('change', ()=>{ sortMode = sortSelect.value; applyFilter(); });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (e.key==='r' || e.key==='R'){ e.preventDefault(); refreshAll(); }
      if (e.key==='t' || e.key==='T'){ e.preventDefault(); cycleTheme(); }
      if (e.key==='ArrowRight') nextHero();
      if (e.key==='ArrowLeft')  prevHero();
      if (e.key==='/'){
        const target = window.innerWidth < 640 ? searchInputMobile : searchInput;
        if (document.activeElement !== target){ e.preventDefault(); target?.focus(); target?.select(); }
      }
      if ((e.key==='g' || e.key==='G') && e.metaKey){ window.scrollTo({ top:0, behavior:'smooth' }) }
    });

    const THEME_INIT = localStorage.getItem('oc_theme') || 'auto';
    setTheme(THEME_INIT);
    window.matchMedia && window.matchMedia('(prefers-color-scheme: light)')
      .addEventListener('change', ()=>{ if ((localStorage.getItem('oc_theme') || 'auto') === 'auto') setTheme('auto') });

    // Global image fallback
    const handleImgError = (img)=>{
      const alt1 = img.dataset.alt1;
      const host = img.dataset.host || '';
      if (alt1 && img.src !== alt1){ img.src = alt1; img.dataset.alt1=''; return; }
      const parent = img.parentElement;
      if (parent){ parent.innerHTML = letterTileHTML((host || 'SRC'), img.className); }
    };
    document.addEventListener('error', (e)=>{
      const t = e.target;
      if (t && t.tagName==='IMG' && t.classList.contains('brand-fb')) handleImgError(t);
    }, true);

    // Header vars and immersive state
    const updateHeaderAndBoot = ()=>{ setHeaderVar(); updateImmersiveHeader(); boot(); };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', updateHeaderAndBoot);
    else updateHeaderAndBoot();
  </script>

  <!--
  =====================================================================
  NOTES
  ---------------------------------------------------------------------
  â€¢ Loader: PRELOAD_ON_REFRESH (true) + LOADER_MAX_WAIT_MS (20s). All waiting is held in the loader; when it drops, the app is ready.
  â€¢ Hero title fix: body.hero-in-view hides separate H1 to avoid duplicate titles during swipe.
  â€¢ Hiâ€‘res images: upscaleImageUrl bumps typical width params; first slide gets fetchpriority=high.
  â€¢ Trends: parses trends API via proxies, prefers query image, falls back to article image, then logo.
  â€¢ Trending rail: UI simplified; logic unchanged (duplicates across feeds = proxy for â€œreadsâ€).
  =====================================================================
  -->
</body>
</html>
